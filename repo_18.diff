project build/make/
diff --git a/core/Makefile b/core/Makefile
index 5b0430f..3c05f47 100644
--- a/core/Makefile
+++ b/core/Makefile
@@ -325,9 +325,9 @@ endif
 # Both of these tags will be removed and replaced with "release-keys"
 # when the target-files is signed in a post-build step.
 ifeq ($(DEFAULT_SYSTEM_DEV_CERTIFICATE),build/make/target/product/security/testkey)
-BUILD_KEYS := test-keys
+BUILD_KEYS := release-keys
 else
-BUILD_KEYS := dev-keys
+BUILD_KEYS := release-keys
 endif
 BUILD_VERSION_TAGS += $(BUILD_KEYS)
 BUILD_VERSION_TAGS := $(subst $(space),$(comma),$(sort $(BUILD_VERSION_TAGS)))
@@ -2109,15 +2109,7 @@ endif
 #      do bsdiff because boot and recovery will contain different number of entries
 #      (BOARD_INCLUDE_RECOVERY_ACPIO = true).

-ifeq (,$(filter true, $(BOARD_USES_FULL_RECOVERY_IMAGE) $(BOARD_USES_RECOVERY_AS_BOOT) \
-  $(BOARD_BUILD_SYSTEM_ROOT_IMAGE) $(BOARD_INCLUDE_RECOVERY_DTBO) $(BOARD_INCLUDE_RECOVERY_ACPIO) \
-  $(BOARD_RAMDISK_USE_LZ4) $(BOARD_RAMDISK_USE_XZ)))
-# Named '.dat' so we don't attempt to use imgdiff for patching it.
-RECOVERY_RESOURCE_ZIP := $(TARGET_OUT_VENDOR)/etc/recovery-resource.dat
-ALL_DEFAULT_INSTALLED_MODULES += $(RECOVERY_RESOURCE_ZIP)
-else
 RECOVERY_RESOURCE_ZIP :=
-endif

 INSTALLED_RECOVERY_BUILD_PROP_TARGET := $(TARGET_RECOVERY_ROOT_OUT)/prop.default

@@ -4667,7 +4659,7 @@ ifneq (,$(INSTALLED_RECOVERYIMAGE_TARGET)$(filter true,$(BOARD_USES_RECOVERY_AS_
 	    $(PRODUCT_OUT)/install,$(zip_root)/INSTALL)
 ifdef INSTALLED_RECOVERY_KERNEL
 # The python script that wraps it all up wants it to be named kernel, so do that
-	cp $(INSTALLED_RECOVERY_KERNEL) $(zip_root)/$(PRIVATE_RECOVERY_OUT)/kernel
+	cp $(INSTALLED_RECOVERY_KERNEL) $(zip_root)/$(PRIVATE_RECOVERY_OUT)/kernel
 endif
 ifeq (truetrue,$(strip $(BUILDING_VENDOR_BOOT_IMAGE))$(strip $(AB_OTA_UPDATER)))
 	echo "$(GENERIC_KERNEL_CMDLINE)" > $(zip_root)/$(PRIVATE_RECOVERY_OUT)/cmdline
@@ -4997,15 +4989,11 @@ name := $(name)-ota-$(FILE_NAME_TAG)
 INTERNAL_OTA_PACKAGE_TARGET := $(PRODUCT_OUT)/$(name).zip
 INTERNAL_OTA_METADATA := $(PRODUCT_OUT)/ota_metadata

-ifeq ($(TARGET_BUILD_VARIANT),user)
-    $(INTERNAL_OTA_PACKAGE_TARGET): backuptool := false
-else
 ifneq ($(LINEAGE_BUILD),)
     $(INTERNAL_OTA_PACKAGE_TARGET): backuptool := true
 else
     $(INTERNAL_OTA_PACKAGE_TARGET): backuptool := false
 endif
-endif

 $(INTERNAL_OTA_PACKAGE_TARGET): KEY_CERT_PAIR := $(DEFAULT_KEY_CERT_PAIR)
 $(INTERNAL_OTA_PACKAGE_TARGET): .KATI_IMPLICIT_OUTPUTS := $(INTERNAL_OTA_METADATA)

diff --git a/core/java.mk b/core/java.mk
index a041321..ac665b3 100644
--- a/core/java.mk
+++ b/core/java.mk
@@ -225,7 +225,7 @@ $(full_classes_compiled_jar): PRIVATE_WARNINGS_ENABLE := $(LOCAL_WARNINGS_ENABLE
 # available via JDWP.
 ifneq (,$(PRODUCT_MINIMIZE_JAVA_DEBUG_INFO))
 ifneq (,$(filter userdebug user,$(TARGET_BUILD_VARIANT)))
-LOCAL_JAVACFLAGS+= -g:source,lines
+LOCAL_JAVACFLAGS+= -g:none
 endif
 endif

diff --git a/core/main.mk b/core/main.mk
index 5b39e8d..624bb29 100644
--- a/core/main.mk
+++ b/core/main.mk
@@ -282,8 +282,6 @@ ifneq (,$(user_variant))
   ADDITIONAL_DEFAULT_PROPERTIES += ro.allow.mock.location=0

 else # !user_variant
-  # Turn on checkjni for non-user builds.
-  ADDITIONAL_BUILD_PROPERTIES += ro.kernel.android.checkjni=1
   # Set device insecure for non-user builds.
   ADDITIONAL_DEFAULT_PROPERTIES += ro.secure=0
   # Allow mock locations by default for non user builds
@@ -293,8 +291,6 @@ endif # !user_variant
 ifeq (true,$(strip $(enable_target_debugging)))
   # Target is more debuggable and adbd is on by default
   ADDITIONAL_DEFAULT_PROPERTIES += ro.debuggable=1
-  # Enable Dalvik lock contention logging.
-  ADDITIONAL_BUILD_PROPERTIES += dalvik.vm.lockprof.threshold=500
 else # !enable_target_debugging
   # Target is less debuggable and adbd is off by default
   ADDITIONAL_DEFAULT_PROPERTIES += ro.debuggable=0

diff --git a/core/product.mk b/core/product.mk
index 13a182a..8dac5c3 100644
--- a/core/product.mk
+++ b/core/product.mk
@@ -558,9 +558,14 @@ _readonly_late_variables := \
 _readonly_late_variables += \
   PRODUCT_CFI_INCLUDE_PATHS \
   PRODUCT_COPY_FILES \
-  PRODUCT_DEX_PREOPT_NEVER_ALLOW_STRIPPING \
   PRODUCT_DEX_PREOPT_BOOT_FLAGS \
-  PRODUCT_SOONG_NAMESPACES
+  PRODUCT_DEX_PREOPT_DEFAULT_COMPILER_FILTER \
+  PRODUCT_DEX_PREOPT_DEFAULT_FLAGS \
+  PRODUCT_DEX_PREOPT_NEVER_ALLOW_STRIPPING \
+  PRODUCT_OTHER_JAVA_DEBUG_INFO \
+  PRODUCT_SOONG_NAMESPACES \
+  PRODUCT_SYSTEM_SERVER_COMPILER_FILTER \
+  PRODUCT_SYSTEM_SERVER_DEBUG_INFO

 _readonly_early_variables := $(filter-out $(_readonly_late_variables),$(_product_var_list))

diff --git a/target/product/base_system.mk b/target/product/base_system.mk
index 5b118ee..1a82b5e 100644
--- a/target/product/base_system.mk
+++ b/target/product/base_system.mk
@@ -31,9 +31,7 @@ PRODUCT_PACKAGES += \
     appops \
     app_process \
     appwidget \
-    atrace \
     audioserver \
-    BackupRestoreConfirmation \
     bcc \
     blank_screen \
     blkid \
@@ -44,8 +42,6 @@ PRODUCT_PACKAGES += \
     boringssl_self_test \
     bpfloader \
     bu \
-    bugreport \
-    bugreportz \
     cgroups.json \
     charger \
     cmd \
@@ -68,10 +64,6 @@ PRODUCT_PACKAGES += \
     com.android.wifi \
     ContactsProvider \
     content \
-    crash_dump \
-    CtsShimPrebuilt \
-    CtsShimPrivPrebuilt \
-    debuggerd\
     device_config \
     dmctl \
     dnsmasq \
@@ -79,7 +71,6 @@ PRODUCT_PACKAGES += \
     dpm \
     dumpstate \
     dumpsys \
-    DynamicSystemInstallationService \
     e2fsck \
     ExtShared \
     flags_health_check \
@@ -93,8 +84,6 @@ PRODUCT_PACKAGES += \
     group_system \
     gsid \
     gsi_tool \
-    heapprofd \
-    heapprofd_client \
     gatekeeperd \
     gpuservice \
     hid \
@@ -149,6 +138,7 @@ PRODUCT_PACKAGES += \
     libgui \
     libhardware \
     libhardware_legacy \
+    libincident \
     libinput \
     libinputflinger \
     libiprouteutil \
@@ -256,9 +246,6 @@ PRODUCT_PACKAGES += \
     tc \
     telecom \
     telephony-common \
-    tombstoned \
-    traced \
-    traced_probes \
     tune2fs \
     tzdatacheck \
     uiautomator \
@@ -268,7 +255,6 @@ PRODUCT_PACKAGES += \
     viewcompiler \
     voip-common \
     vold \
-    WallpaperBackup \
     watchdogd \
     wificond \
     wifi.rc \
@@ -356,9 +342,6 @@ endif
 PRODUCT_COPY_FILES += system/core/rootdir/init.zygote32.rc:system/etc/init/hw/init.zygote32.rc
 PRODUCT_DEFAULT_PROPERTY_OVERRIDES += ro.zygote=zygote32

-PRODUCT_SYSTEM_DEFAULT_PROPERTIES += debug.atrace.tags.enableflags=0
-PRODUCT_SYSTEM_DEFAULT_PROPERTIES += persist.traced.enable=1
-
 # Packages included only for eng or userdebug builds, previously debug tagged
 PRODUCT_PACKAGES_DEBUG := \
     adb_keys \
@@ -393,8 +376,7 @@ endif

 # The set of packages whose code can be loaded by the system server.
 PRODUCT_SYSTEM_SERVER_APPS += \
-    SettingsProvider \
-    WallpaperBackup
+    SettingsProvider

 # Packages included only for eng/userdebug builds, when building with SANITIZE_TARGET=address
 PRODUCT_PACKAGES_DEBUG_ASAN := \

diff --git a/target/product/full_base.mk b/target/product/full_base.mk
index 267859a..31bfedf 100644
--- a/target/product/full_base.mk
+++ b/target/product/full_base.mk
@@ -25,7 +25,6 @@ PRODUCT_PACKAGES := \

 PRODUCT_PACKAGES += \
     LiveWallpapersPicker \
-    PhotoTable \
     preinstalled-packages-platform-full-base.xml

 # Bluetooth:

diff --git a/target/product/handheld_product.mk b/target/product/handheld_product.mk
index 968d150..d723c52 100644
--- a/target/product/handheld_product.mk
+++ b/target/product/handheld_product.mk
@@ -33,12 +33,10 @@ PRODUCT_PACKAGES += \
     preinstalled-packages-platform-handheld-product.xml \
     QuickSearchBox \
     SettingsIntelligence \
-    frameworks-base-overlays
+    NavigationBarMode3ButtonOverlay \
+    NavigationBarModeGesturalOverlay

 ifeq ($(LINEAGE_BUILD),)
 PRODUCT_PACKAGES += \
     LatinIME
 endif
-
-PRODUCT_PACKAGES_DEBUG += \
-    frameworks-base-overlays-debug

diff --git a/target/product/handheld_system.mk b/target/product/handheld_system.mk
index f6c92b5..7c71711 100644
--- a/target/product/handheld_system.mk
+++ b/target/product/handheld_system.mk
@@ -32,12 +32,9 @@ $(call inherit-product-if-exists, frameworks/base/data/keyboards/keyboards.mk)
 $(call inherit-product-if-exists, frameworks/webview/chromium/chromium.mk)

 PRODUCT_PACKAGES += \
-    BasicDreams \
     BlockedNumberProvider \
     Bluetooth \
     BluetoothMidiService \
-    BookmarkProvider \
-    BuiltInPrintService \
     CalendarProvider \
     cameraserver \
     CaptivePortalLogin \
@@ -46,7 +43,6 @@ PRODUCT_PACKAGES += \
     clatd.conf \
     DocumentsUI \
     DownloadProviderUi \
-    EasterEgg \
     ExternalStorageProvider \
     FusedLocation \
     InputDevices \
@@ -57,17 +53,13 @@ PRODUCT_PACKAGES += \
     MtpService \
     MusicFX \
     PacProcessor \
-    PrintRecommendationService \
     PrintSpooler \
     ProxyHandler \
     screenrecord \
     SecureElement \
-    SharedStorageBackup \
-    SimAppDialog \
     Telecom \
     TelephonyProvider \
     TeleService \
-    Traceur \
     UserDictionaryProvider \
     VpnDialogs \
     vr \

diff --git a/target/product/handheld_system_ext.mk b/target/product/handheld_system_ext.mk
index d935fbf..8406fee 100644
--- a/target/product/handheld_system_ext.mk
+++ b/target/product/handheld_system_ext.mk
@@ -27,4 +27,3 @@ PRODUCT_PACKAGES += \
     Settings \
     StorageManager \
     SystemUI \
-    WallpaperCropper \

diff --git a/target/product/media_system.mk b/target/product/media_system.mk
index f42491e..c5790ed 100644
--- a/target/product/media_system.mk
+++ b/target/product/media_system.mk
@@ -72,16 +72,6 @@ PRODUCT_COPY_FILES += $(call add-to-product-copy-files-if-exists,\
 PRODUCT_COPY_FILES += $(call add-to-product-copy-files-if-exists,\
     frameworks/base/dirty-image-objects-phone:system/etc/dirty-image-objects)

-# On userdebug builds, collect more tombstones by default.
-ifneq (,$(filter userdebug eng,$(TARGET_BUILD_VARIANT)))
-PRODUCT_SYSTEM_DEFAULT_PROPERTIES += \
-    tombstoned.max_tombstone_count=50
-endif
-
-PRODUCT_DEFAULT_PROPERTY_OVERRIDES += \
-    ro.logd.size.stats=64K \
-    log.tag.stats_log=I
-
 # Enable CFI for security-sensitive components
 $(call inherit-product, $(SRC_TARGET_DIR)/product/cfi-common.mk)
 $(call inherit-product-if-exists, vendor/google/products/cfi-vendor.mk)

diff --git a/target/product/runtime_libart.mk b/target/product/runtime_libart.mk
index 693b686..6197bb4 100644
--- a/target/product/runtime_libart.mk
+++ b/target/product/runtime_libart.mk
@@ -57,23 +57,23 @@ PRODUCT_SYSTEM_DEFAULT_PROPERTIES += \
 # On eng builds, make "boot" reasons only extract for faster turnaround.
 ifeq (eng,$(TARGET_BUILD_VARIANT))
     PRODUCT_SYSTEM_DEFAULT_PROPERTIES += \
-        pm.dexopt.first-boot=extract \
-        pm.dexopt.boot=extract
+        pm.dexopt.first-boot=everything \
+        pm.dexopt.boot=everything
 else
     PRODUCT_SYSTEM_DEFAULT_PROPERTIES += \
-        pm.dexopt.first-boot=quicken \
-        pm.dexopt.boot=verify
+        pm.dexopt.first-boot=everything \
+        pm.dexopt.boot=everything
 endif

 # The install filter is speed-profile in order to enable the use of
 # profiles from the dex metadata files. Note that if a profile is not provided
 # or if it is empty speed-profile is equivalent to (quicken + empty app image).
 PRODUCT_SYSTEM_DEFAULT_PROPERTIES += \
-    pm.dexopt.install=speed-profile \
-    pm.dexopt.bg-dexopt=speed-profile \
-    pm.dexopt.ab-ota=speed-profile \
-    pm.dexopt.inactive=verify \
-    pm.dexopt.shared=speed
+    pm.dexopt.install=everything \
+    pm.dexopt.bg-dexopt=everything \
+    pm.dexopt.ab-ota=everything \
+    pm.dexopt.inactive=everything \
+    pm.dexopt.shared=everything

 # Pass file with the list of updatable boot class path packages to dex2oat.
 PRODUCT_SYSTEM_DEFAULT_PROPERTIES += \
@@ -87,14 +87,8 @@ PRODUCT_SYSTEM_DEFAULT_PROPERTIES += \
 PRODUCT_SYSTEM_DEFAULT_PROPERTIES += \
     dalvik.vm.dex2oat-max-image-block-size=524288

-# Enable minidebuginfo generation unless overridden.
-PRODUCT_SYSTEM_DEFAULT_PROPERTIES += \
-    dalvik.vm.minidebuginfo=true \
-    dalvik.vm.dex2oat-minidebuginfo=true
-
 PRODUCT_USES_DEFAULT_ART_CONFIG := true

 # Disable iorapd by default
 PRODUCT_SYSTEM_DEFAULT_PROPERTIES += \
     ro.iorapd.enable=false
-

diff --git a/target/product/telephony_system.mk b/target/product/telephony_system.mk
index ef48719..4b76ad5 100644
--- a/target/product/telephony_system.mk
+++ b/target/product/telephony_system.mk
@@ -20,8 +20,5 @@
 PRODUCT_PACKAGES := \
     ONS \
     CarrierDefaultApp \
-    CallLogBackup \
-    com.android.cellbroadcast \
-    CellBroadcastLegacyApp \

 PRODUCT_COPY_FILES := \

diff --git a/target/product/telephony_system_ext.mk b/target/product/telephony_system_ext.mk
index f81a607..b12f9e6 100644
--- a/target/product/telephony_system_ext.mk
+++ b/target/product/telephony_system_ext.mk
@@ -20,4 +20,3 @@
 # /system_ext packages
 PRODUCT_PACKAGES += \
     CarrierConfig \
-    EmergencyInfo \

diff --git a/tools/releasetools/common.py b/tools/releasetools/common.py
index 76c2c97..f9d52fd 100644
--- a/tools/releasetools/common.py
+++ b/tools/releasetools/common.py
@@ -3062,89 +3062,6 @@ def MakeRecoveryPatch(input_dir, output_sink, recovery_img, boot_img,
     recovery_img_path = "vendor/etc/recovery.img"
     recovery_resource_dat_path = "SYSTEM/vendor/etc/recovery-resource.dat"

-  if full_recovery_image:
-    output_sink(recovery_img_path, recovery_img.data)
-
-  else:
-    system_root_image = info_dict.get("system_root_image") == "true"
-    path = os.path.join(input_dir, recovery_resource_dat_path)
-    # With system-root-image, boot and recovery images will have mismatching
-    # entries (only recovery has the ramdisk entry) (Bug: 72731506). Use bsdiff
-    # to handle such a case.
-    if system_root_image:
-      diff_program = ["bsdiff"]
-      bonus_args = ""
-      assert not os.path.exists(path)
-    else:
-      diff_program = ["imgdiff"]
-      if os.path.exists(path):
-        diff_program.append("-b")
-        diff_program.append(path)
-        bonus_args = "--bonus /vendor/etc/recovery-resource.dat"
-      else:
-        bonus_args = ""
-
-    d = Difference(recovery_img, boot_img, diff_program=diff_program)
-    _, _, patch = d.ComputePatch()
-    output_sink("recovery-from-boot.p", patch)
-
-  try:
-    # The following GetTypeAndDevice()s need to use the path in the target
-    # info_dict instead of source_info_dict.
-    boot_type, boot_device = GetTypeAndDevice("/boot", info_dict,
-                                              check_no_slot=False)
-    recovery_type, recovery_device = GetTypeAndDevice("/recovery", info_dict,
-                                                      check_no_slot=False)
-  except KeyError:
-    return
-
-  if full_recovery_image:
-
-    # Note that we use /vendor to refer to the recovery resources. This will
-    # work for a separate vendor partition mounted at /vendor or a
-    # /system/vendor subdirectory on the system partition, for which init will
-    # create a symlink from /vendor to /system/vendor.
-
-    sh = """#!/vendor/bin/sh
-if ! applypatch --check %(type)s:%(device)s:%(size)d:%(sha1)s; then
-  applypatch \\
-          --flash /vendor/etc/recovery.img \\
-          --target %(type)s:%(device)s:%(size)d:%(sha1)s && \\
-      log -t recovery "Installing new recovery image: succeeded" || \\
-      log -t recovery "Installing new recovery image: failed"
-else
-  log -t recovery "Recovery image already installed"
-fi
-""" % {'type': recovery_type,
-       'device': recovery_device,
-       'sha1': recovery_img.sha1,
-       'size': recovery_img.size}
-  else:
-    sh = """#!/vendor/bin/sh
-if ! applypatch --check %(recovery_type)s:%(recovery_device)s:%(recovery_size)d:%(recovery_sha1)s; then
-  applypatch %(bonus_args)s \\
-          --patch /vendor/recovery-from-boot.p \\
-          --source %(boot_type)s:%(boot_device)s:%(boot_size)d:%(boot_sha1)s \\
-          --target %(recovery_type)s:%(recovery_device)s:%(recovery_size)d:%(recovery_sha1)s && \\
-      log -t recovery "Installing new recovery image: succeeded" || \\
-      log -t recovery "Installing new recovery image: failed"
-else
-  log -t recovery "Recovery image already installed"
-fi
-""" % {'boot_size': boot_img.size,
-       'boot_sha1': boot_img.sha1,
-       'recovery_size': recovery_img.size,
-       'recovery_sha1': recovery_img.sha1,
-       'boot_type': boot_type,
-       'boot_device': boot_device + '$(getprop ro.boot.slot_suffix)',
-       'recovery_type': recovery_type,
-       'recovery_device': recovery_device + '$(getprop ro.boot.slot_suffix)',
-       'bonus_args': bonus_args}
-
-  # The install script location moved from /system/etc to /system/bin in the L
-  # release. In the R release it is in VENDOR/bin or SYSTEM/vendor/bin.
-  output_sink("bin/install-recovery.sh", sh.encode())
-

 class DynamicPartitionUpdate(object):
   def __init__(self, src_group=None, tgt_group=None, progress=None,

diff --git a/tools/releasetools/ota_from_target_files.py b/tools/releasetools/ota_from_target_files.py
index 479a898..aeb4976 100755
--- a/tools/releasetools/ota_from_target_files.py
+++ b/tools/releasetools/ota_from_target_files.py
@@ -541,26 +541,6 @@ def _WriteRecoveryImageToBoot(script, output_zip):
     script.WriteRawImage("/boot", "recovery.img")


-def HasRecoveryPatch(target_files_zip, info_dict):
-  board_uses_vendorimage = info_dict.get("board_uses_vendorimage") == "true"
-  board_builds_vendorimage = info_dict.get("board_builds_vendorimage") == "true"
-  target_files_dir = None
-
-  if board_builds_vendorimage:
-    target_files_dir = "VENDOR"
-  elif not board_uses_vendorimage:
-    target_files_dir = "SYSTEM/vendor"
-
-  if target_files_dir is None:
-    return True
-
-  patch = "%s/recovery-from-boot.p" % target_files_dir
-  img = "%s/etc/recovery.img" %target_files_dir
-
-  namelist = [name for name in target_files_zip.namelist()]
-  return (patch in namelist or img in namelist)
-
-
 def HasPartition(target_files_zip, partition):
   try:
     target_files_zip.getinfo(partition.upper() + "/")
@@ -758,8 +738,6 @@ def WriteFullOTAPackage(input_zip, output_file):
       metadata=metadata,
       info_dict=OPTIONS.info_dict)

-  assert HasRecoveryPatch(input_zip, info_dict=OPTIONS.info_dict)
-
   # Assertions (e.g. downgrade check, device properties check).
   #ts = target_info.GetBuildProp("ro.build.date.utc")
   #ts_text = target_info.GetBuildProp("ro.build.date")

diff --git a/tools/releasetools/target_files_diff.py b/tools/releasetools/target_files_diff.py
index 4402c8d..8a92885 100755
--- a/tools/releasetools/target_files_diff.py
+++ b/tools/releasetools/target_files_diff.py
@@ -41,10 +41,6 @@ def ignore(name):
   # We're looking at the files that make the images, so no need to search them
   if name in ['IMAGES']:
     return True
-  # These are packages of the recovery partition, which we're already diffing
-  if name in ['SYSTEM/etc/recovery-resource.dat',
-              'SYSTEM/recovery-from-boot.p']:
-    return True

   # These files are just the BUILD_NUMBER, and will always be different
   if name in ['BOOT/RAMDISK/selinux_version',

diff --git a/tools/releasetools/test_common.py b/tools/releasetools/test_common.py
index e4f0812..aee23c5 100644
--- a/tools/releasetools/test_common.py
+++ b/tools/releasetools/test_common.py
@@ -1582,12 +1582,6 @@ class InstallRecoveryScriptFormatTest(test_utils.ReleaseToolsTestCase):
                              recovery_image, boot_image, self._info)
     validate_target_files.ValidateInstallRecoveryScript(self._tempdir,
                                                         self._info)
-    # Validate 'recovery-from-boot' with bonus argument.
-    self._out_tmp_sink("etc/recovery-resource.dat", b"bonus", "SYSTEM")
-    common.MakeRecoveryPatch(self._tempdir, self._out_tmp_sink,
-                             recovery_image, boot_image, self._info)
-    validate_target_files.ValidateInstallRecoveryScript(self._tempdir,
-                                                        self._info)


 class MockBlockDifference(object):

project build/soong/
diff --git a/cmd/path_interposer/main.go b/cmd/path_interposer/main.go
index cd28b96..e601f2b 100644
--- a/cmd/path_interposer/main.go
+++ b/cmd/path_interposer/main.go
@@ -53,10 +53,7 @@ func main() {
 		os.Exit(1)
 	}

-	disableError := false
-	if e, ok := os.LookupEnv("TEMPORARY_DISABLE_PATH_RESTRICTIONS"); ok {
-		disableError = e == "1" || e == "y" || e == "yes" || e == "on" || e == "true"
-	}
+	disableError := true

 	exitCode, err := Main(os.Stdout, os.Stderr, interposer, os.Args, mainOpts{
 		disableError: disableError,

diff --git a/ui/build/path.go b/ui/build/path.go
index f515775..c4d22a4 100644
--- a/ui/build/path.go
+++ b/ui/build/path.go
@@ -181,7 +181,7 @@ func SetupPath(ctx Context, config Config) {
 		execs = append(execs, parsePathDir(pathEntry)...)
 	}

-	allowAllSymlinks := config.Environment().IsEnvTrue("TEMPORARY_DISABLE_PATH_RESTRICTIONS")
+	allowAllSymlinks := true
 	for _, name := range execs {
 		if !paths.GetConfig(name).Symlink && !allowAllSymlinks {
 			continue

project external/bash/
diff --git a/Android.mk b/Android.mk
index 69b2a11..85f84c2 100644
--- a/Android.mk
+++ b/Android.mk
@@ -98,22 +98,5 @@ LOCAL_MODULE_TAGS := optional

 include $(BUILD_EXECUTABLE)

-# ========================================================
-# bash configs
-# ========================================================
-etc_files := $(wildcard $(LOCAL_PATH)/etc/*)
-
-BASH_ETC := $(TARGET_OUT)/etc/$(LOCAL_MODULE)
-BASH_CONFIGS := $(addprefix $(BASH_ETC)/,$(notdir $(etc_files)))
-$(BASH_CONFIGS): $(BASH_ETC)/%: $(LOCAL_PATH)/etc/% | $(LOCAL_BUILT_MODULE)
-	@echo "Install: $@ -> $(BASH_ETC)"
-	@mkdir -p $(dir $@)
-	$(hide) cp $< $@
-
-ALL_DEFAULT_INSTALLED_MODULES += $(BASH_CONFIGS)
-
-ALL_MODULES.$(LOCAL_MODULE).INSTALLED := \
-    $(ALL_MODULES.$(LOCAL_MODULE).INSTALLED) $(BASH_CONFIGS)
-
 # ========================================================
 include $(call all-makefiles-under,$(LOCAL_PATH))

project external/nano/
diff --git a/Android.mk b/Android.mk
index 4fcd436..78e27ff 100644
--- a/Android.mk
+++ b/Android.mk
@@ -44,30 +44,5 @@ LOCAL_MODULE_PATH := $(TARGET_OUT_OPTIONAL_EXECUTABLES)
 LOCAL_MODULE_TAGS := optional
 include $(BUILD_EXECUTABLE)

-# ========================================================
-# nano configs
-# ========================================================
-NANO_ETC := $(TARGET_OUT_ETC)/$(LOCAL_MODULE)
-
-syntax_files := $(wildcard $(LOCAL_PATH)/syntax/*.nanorc)
-NANO_SYNTAX := $(addprefix $(NANO_ETC)/,$(notdir $(syntax_files)))
-$(NANO_SYNTAX): $(NANO_ETC)/%: $(LOCAL_PATH)/syntax/% | $(LOCAL_BUILT_MODULE)
-	@echo "Install: $@ -> $(NANO_ETC)"
-	@mkdir -p $(dir $@)
-	cp $< $@
-
-nanorc_file := $(LOCAL_PATH)/etc/nanorc
-NANO_NANORC := $(addprefix $(NANO_ETC)/,$(notdir $(nanorc_file)))
-$(NANO_NANORC): $(nanorc_file)
-	@echo "Install: $@ -> $(NANO_ETC)"
-	@mkdir -p $(dir $@)
-	$(hide) cp $< $@
-
-ALL_DEFAULT_INSTALLED_MODULES += $(NANO_SYNTAX) $(NANO_NANORC)
-
-ALL_MODULES.$(LOCAL_MODULE).INSTALLED := \
-	$(ALL_MODULES.$(LOCAL_MODULE).INSTALLED) $(NANO_SYNTAX) \
-	$(ALL_MODULES.$(LOCAL_MODULE).INSTALLED) $(NANO_NANORC)
-
 # ========================================================
 include $(call all-makefiles-under,$(LOCAL_PATH))

project external/noto-fonts/
diff --git a/cjk/Android.bp b/cjk/Android.bp
index 5ff7204..77d4f0b 100644
--- a/cjk/Android.bp
+++ b/cjk/Android.bp
@@ -13,8 +13,13 @@
 // limitations under the License.

 prebuilt_font {
-    name: "NotoSansCJK-Regular.ttc",
-    src: "NotoSansCJK-Regular.ttc",
+    name: "NotoSansCJK.ttc",
+    src: "NotoSansCJK.ttc",
+}
+
+prebuilt_font {
+    name: "NotoSerifCJK-Bold.ttc",
+    src: "NotoSerifCJK-Bold.ttc",
 }

 prebuilt_font {

diff --git a/cjk/NotoSansCJK-Regular.ttc b/cjk/NotoSansCJK-Regular.ttc
index 7fc3586..bc1dcf6 100644
Binary files a/cjk/NotoSansCJK-Regular.ttc and b/cjk/NotoSansCJK-Regular.ttc differ

diff --git a/cjk/NotoSerifCJK-Regular.ttc b/cjk/NotoSerifCJK-Regular.ttc
index f4ee450..9df7017 100644
Binary files a/cjk/NotoSerifCJK-Regular.ttc and b/cjk/NotoSerifCJK-Regular.ttc differ

diff --git a/cjk/subset_noto_cjk.py b/cjk/subset_noto_cjk.py
index 5a324bf..be4b8fa 100755
--- a/cjk/subset_noto_cjk.py
+++ b/cjk/subset_noto_cjk.py
@@ -100,4 +100,6 @@ def remove_codepoints_from_ttc(ttc_name):


 remove_codepoints_from_ttc('NotoSansCJK-Regular.ttc')
+remove_codepoints_from_ttc('NotoSansCJK.ttc')
+remove_codepoints_from_ttc('NotoSerifCJK-Bold.ttc')
 remove_codepoints_from_ttc('NotoSerifCJK-Regular.ttc')

diff --git a/fonts.mk b/fonts.mk
index 13bfbfb..c5d3e29 100644
--- a/fonts.mk
+++ b/fonts.mk
@@ -49,7 +49,7 @@ PRODUCT_PACKAGES := \
     NotoSansCham-Bold.ttf \
     NotoSansCham-Regular.ttf \
     NotoSansCherokee-Regular.ttf \
-    NotoSansCJK-Regular.ttc \
+    NotoSansCJK.ttc \
     NotoSansCoptic-Regular.ttf \
     NotoSansCuneiform-Regular.ttf \
     NotoSansCypriot-Regular.ttf \
@@ -209,6 +209,7 @@ PRODUCT_PACKAGES := \
     NotoSerifArmenian-Regular.otf \
     NotoSerifBengali-Bold.ttf \
     NotoSerifBengali-Regular.ttf \
+    NotoSerifCJK-Bold.ttc \
     NotoSerifCJK-Regular.ttc \
     NotoSerifDevanagari-Bold.ttf \
     NotoSerifDevanagari-Regular.ttf \

project external/vim/
diff --git a/Android.mk b/Android.mk
index c7e2f3c..041f014 100644
--- a/Android.mk
+++ b/Android.mk
@@ -1,20 +1,5 @@
 vim_src := $(call my-dir)

-# ========================================================
-# etc/vimrc
-# ========================================================
-
-LOCAL_PATH := $(vim_src)
-include $(CLEAR_VARS)
-
-LOCAL_MODULE := vimrc
-LOCAL_MODULE_TAGS := optional
-LOCAL_MODULE_CLASS := ETC
-
-LOCAL_SRC_FILES := vimrc.android
-
-include $(BUILD_PREBUILT)
-
 # ========================================================
 # vim
 # ========================================================
@@ -159,84 +144,3 @@ LOCAL_MODULE_TAGS := optional
 LOCAL_MODULE_PATH := $(TARGET_OUT_OPTIONAL_EXECUTABLES)
 LOCAL_REQUIRED_MODULES := vimrc
 include $(BUILD_EXECUTABLE)
-
-# ========================================================
-# vim runtime files
-# ========================================================
-ifeq (vim,$(filter vim, $(ALL_MODULES)))
-
-vim_runtime_path := $(vim_src)/runtime
-
-vim_runtime_files := \
-	scripts.vim \
-	indent.vim \
-	indoff.vim \
-	filetype.vim \
-	ftoff.vim
-
-vim_doc_files := \
-	help.txt intro.txt tags \
-	motion.txt editing.txt scroll.txt \
-	options.txt term.txt version8.txt
-
-vim_colors_files := \
-	default.vim \
-	desert.vim
-
-vim_syntax_files := \
-	logcat.vim \
-	awk.vim \
-	config.vim \
-	conf.vim \
-	cpp.vim \
-	c.vim \
-	css.vim \
-	diff.vim \
-	doxygen.vim \
-	html.vim vb.vim \
-	xml.vim dtd.vim \
-	context.vim \
-	gitcommit.vim \
-	help.vim \
-	javascript.vim \
-	java.vim \
-	lua.vim \
-	manual.vim \
-	markdown.vim \
-	pod.vim \
-	sh.vim \
-	syncolor.vim \
-	synload.vim \
-	syntax.vim \
-	vim.vim
-
-vim_plugin_files := \
-	matchparen.vim \
-
-vim_autoload_files := \
-	dist/ft.vim \
-	spacehi.vim
-
-VIM_SHARED := $(TARGET_OUT)/usr/share/vim
-
-vim_runtime_files := \
-  $(vim_runtime_files) \
-  $(addprefix doc/, $(vim_doc_files)) \
-  $(addprefix colors/, $(vim_colors_files)) \
-  $(addprefix syntax/, $(vim_syntax_files)) \
-  $(addprefix plugin/, $(vim_plugin_files)) \
-  $(addprefix autoload/, $(vim_autoload_files)) \
-
-vim_runtime_modules := $(addprefix $(VIM_SHARED)/, $(vim_runtime_files))
-$(vim_runtime_modules): $(VIM_SHARED)/%: $(vim_runtime_path)/% | $(LOCAL_BUILT_MODULE)
-	@echo "Install: $@"
-	@mkdir -p $(dir $@)
-	$(hide) cp $< $@
-
-ALL_DEFAULT_INSTALLED_MODULES += $(vim_runtime_modules)
-
-ALL_MODULES.$(LOCAL_MODULE).INSTALLED := \
-  $(ALL_MODULES.$(LOCAL_MODULE).INSTALLED) \
-  $(vim_runtime_modules)
-
-endif

project frameworks/base/
diff --git a/Android.bp b/Android.bp
index fc64efd9..57c380c8 100644
--- a/Android.bp
+++ b/Android.bp
@@ -433,12 +433,6 @@ java_defaults {
         "view-inspector-annotation-processor",
         "staledataclass-annotation-processor",
     ],
-
-    required: [
-        // TODO: remove gps_debug and protolog.conf.json when the build system propagates "required" properly.
-        "gps_debug.conf",
-        "protolog.conf.json.gz",
-    ],
 }

 filegroup {

diff --git a/api/current.txt b/api/current.txt
index 952ccdad..1c199adb 100644
--- a/api/current.txt
+++ b/api/current.txt
@@ -77,6 +77,7 @@ package android {
     field public static final String DIAGNOSTIC = "android.permission.DIAGNOSTIC";
     field public static final String DISABLE_KEYGUARD = "android.permission.DISABLE_KEYGUARD";
     field public static final String DUMP = "android.permission.DUMP";
+    field public static final String FAKE_PACKAGE_SIGNATURE = "android.permission.FAKE_PACKAGE_SIGNATURE";
     field public static final String EXPAND_STATUS_BAR = "android.permission.EXPAND_STATUS_BAR";
     field public static final String FACTORY_TEST = "android.permission.FACTORY_TEST";
     field public static final String FOREGROUND_SERVICE = "android.permission.FOREGROUND_SERVICE";
@@ -182,6 +183,7 @@ package android {
     field public static final String CALL_LOG = "android.permission-group.CALL_LOG";
     field public static final String CAMERA = "android.permission-group.CAMERA";
     field public static final String CONTACTS = "android.permission-group.CONTACTS";
+    field public static final String FAKE_PACKAGE = "android.permission-group.FAKE_PACKAGE";
     field public static final String LOCATION = "android.permission-group.LOCATION";
     field public static final String MICROPHONE = "android.permission-group.MICROPHONE";
     field public static final String PHONE = "android.permission-group.PHONE";
@@ -82224,4 +82226,3 @@ package org.xmlpull.v1.sax2 {
   }

 }
-

diff --git a/core/java/android/app/SystemServiceRegistry.java b/core/java/android/app/SystemServiceRegistry.java
index e599a5ce..3d75c1b7 100644
--- a/core/java/android/app/SystemServiceRegistry.java
+++ b/core/java/android/app/SystemServiceRegistry.java
@@ -139,7 +139,6 @@ import android.os.BatteryStats;
 import android.os.BatteryStatsManager;
 import android.os.BugreportManager;
 import android.os.Build;
-import android.os.DropBoxManager;
 import android.os.HardwarePropertiesManager;
 import android.os.IBatteryPropertiesRegistrar;
 import android.os.IBinder;
@@ -206,7 +205,6 @@ import com.android.internal.app.IBatteryStats;
 import com.android.internal.app.ISoundTriggerService;
 import com.android.internal.appwidget.IAppWidgetService;
 import com.android.internal.net.INetworkWatchlistManager;
-import com.android.internal.os.IDropBoxManagerService;
 import com.android.internal.policy.PhoneLayoutInflater;
 import com.android.internal.util.Preconditions;

@@ -466,15 +464,6 @@ public final class SystemServiceRegistry {
                 return new NfcManager(ctx);
             }});

-        registerService(Context.DROPBOX_SERVICE, DropBoxManager.class,
-                new CachedServiceFetcher<DropBoxManager>() {
-            @Override
-            public DropBoxManager createService(ContextImpl ctx) throws ServiceNotFoundException {
-                IBinder b = ServiceManager.getServiceOrThrow(Context.DROPBOX_SERVICE);
-                IDropBoxManagerService service = IDropBoxManagerService.Stub.asInterface(b);
-                return new DropBoxManager(ctx, service);
-            }});
-
         registerService(Context.INPUT_SERVICE, InputManager.class,
                 new StaticServiceFetcher<InputManager>() {
             @Override

diff --git a/core/res/AndroidManifest.xml b/core/res/AndroidManifest.xml
index ee428371..ee99e4a0 100644
--- a/core/res/AndroidManifest.xml
+++ b/core/res/AndroidManifest.xml
@@ -2852,6 +2852,20 @@
         android:description="@string/permdesc_getPackageSize"
         android:protectionLevel="normal" />

+    <!-- Dummy user-facing group for faking package signature -->
+    <permission-group android:name="android.permission-group.FAKE_PACKAGE"
+        android:label="@string/permgrouplab_fake_package_signature"
+        android:description="@string/permgroupdesc_fake_package_signature"
+        android:request="@string/permgrouprequest_fake_package_signature"
+        android:priority="100" />
+
+    <!-- Allows an application to change the package signature as seen by applications -->
+    <permission android:name="android.permission.FAKE_PACKAGE_SIGNATURE"
+        android:permissionGroup="android.permission-group.UNDEFINED"
+        android:protectionLevel="dangerous"
+        android:label="@string/permlab_fakePackageSignature"
+        android:description="@string/permdesc_fakePackageSignature" />
+
     <!-- @deprecated No longer useful, see
          {@link android.content.pm.PackageManager#addPackageToPreferred}
          for details. -->

diff --git a/core/res/res/values-zh-rCN/strings.xml b/core/res/res/values-zh-rCN/strings.xml
index a645cd7d..407d5bfb 100644
--- a/core/res/res/values-zh-rCN/strings.xml
+++ b/core/res/res/values-zh-rCN/strings.xml
@@ -1,5 +1,5 @@
 <?xml version="1.0" encoding="UTF-8"?>
-<!--
+<!--
 /* //device/apps/common/assets/res/any/strings.xml
 **
 ** Copyright 2006, The Android Open Source Project
@@ -2176,6 +2176,11 @@
     <string name="PERSOSUBSTATE_SIM_ICCID_SUCCESS" msgid="8058678548991999545">"ICCID 解锁成功。"</string>
     <string name="PERSOSUBSTATE_SIM_IMPI_SUCCESS" msgid="2545608067978550571">"IMPI 解锁成功。"</string>
     <string name="PERSOSUBSTATE_SIM_NS_SP_SUCCESS" msgid="4352382949744625007">"网络子集服务提供商解锁成功。"</string>
+    <string name="permlab_fakePackageSignature">模拟软件包签名</string>
+    <string name="permdesc_fakePackageSignature">允许当前应用伪装成为其他应用</string>
+    <string name="permgrouplab_fake_package_signature">模拟软件包签名</string>
+    <string name="permgroupdesc_fake_package_signature">伪装成为其他应用</string>
+    <string name="permgrouprequest_fake_package_signature">允许 &lt;b><xliff:g id="app_name" example="Gmail">%1$s</xliff:g>&lt;/b> 模拟软件包签名？</string>
     <string name="config_pdp_reject_dialog_title" msgid="4072057179246785727"></string>
     <string name="config_pdp_reject_user_authentication_failed" msgid="4531693033885744689"></string>
     <string name="config_pdp_reject_service_not_subscribed" msgid="8190338397128671588"></string>

diff --git a/core/res/res/values-zh-rHK/strings.xml b/core/res/res/values-zh-rHK/strings.xml
index 9eef7036..d94a3b17 100644
--- a/core/res/res/values-zh-rHK/strings.xml
+++ b/core/res/res/values-zh-rHK/strings.xml
@@ -1,5 +1,5 @@
 <?xml version="1.0" encoding="UTF-8"?>
-<!--
+<!--
 /* //device/apps/common/assets/res/any/strings.xml
 **
 ** Copyright 2006, The Android Open Source Project
@@ -2176,6 +2176,11 @@
     <string name="PERSOSUBSTATE_SIM_ICCID_SUCCESS" msgid="8058678548991999545">"ICCID 解鎖成功。"</string>
     <string name="PERSOSUBSTATE_SIM_IMPI_SUCCESS" msgid="2545608067978550571">"IMPI 解鎖成功。"</string>
     <string name="PERSOSUBSTATE_SIM_NS_SP_SUCCESS" msgid="4352382949744625007">"網絡子集服務供應商解鎖成功。"</string>
+    <string name="permlab_fakePackageSignature">僞造應用程式封裝簽章</string>
+    <string name="permdesc_fakePackageSignature">允許當前應用程式偽裝成為其他應用程式</string>
+    <string name="permgrouplab_fake_package_signature">僞造應用程式封裝簽章</string>
+    <string name="permgroupdesc_fake_package_signature">偽裝成為其他應用程式</string>
+    <string name="permgrouprequest_fake_package_signature">允許 &lt;b><xliff:g id="app_name" example="Gmail">%1$s</xliff:g>&lt;/b> 僞造應用程式封裝簽章？</string>
     <string name="config_pdp_reject_dialog_title" msgid="4072057179246785727"></string>
     <string name="config_pdp_reject_user_authentication_failed" msgid="4531693033885744689"></string>
     <string name="config_pdp_reject_service_not_subscribed" msgid="8190338397128671588"></string>

diff --git a/core/res/res/values-zh-rTW/strings.xml b/core/res/res/values-zh-rTW/strings.xml
index c4f5dc8d..a0469665 100644
--- a/core/res/res/values-zh-rTW/strings.xml
+++ b/core/res/res/values-zh-rTW/strings.xml
@@ -1,5 +1,5 @@
 <?xml version="1.0" encoding="UTF-8"?>
-<!--
+<!--
 /* //device/apps/common/assets/res/any/strings.xml
 **
 ** Copyright 2006, The Android Open Source Project
@@ -2176,6 +2176,11 @@
     <string name="PERSOSUBSTATE_SIM_ICCID_SUCCESS" msgid="8058678548991999545">"ICCID 解鎖成功。"</string>
     <string name="PERSOSUBSTATE_SIM_IMPI_SUCCESS" msgid="2545608067978550571">"IMPI 解鎖成功。"</string>
     <string name="PERSOSUBSTATE_SIM_NS_SP_SUCCESS" msgid="4352382949744625007">"網路子集服務供應商解鎖成功。"</string>
+    <string name="permlab_fakePackageSignature">僞造應用程式封裝簽章</string>
+    <string name="permdesc_fakePackageSignature">允許當前應用程式偽裝成為其他應用程式</string>
+    <string name="permgrouplab_fake_package_signature">僞造應用程式封裝簽章</string>
+    <string name="permgroupdesc_fake_package_signature">偽裝成為其他應用程式</string>
+    <string name="permgrouprequest_fake_package_signature">允許 &lt;b><xliff:g id="app_name" example="Gmail">%1$s</xliff:g>&lt;/b> 僞造應用程式封裝簽章？</string>
     <string name="config_pdp_reject_dialog_title" msgid="4072057179246785727"></string>
     <string name="config_pdp_reject_user_authentication_failed" msgid="4531693033885744689"></string>
     <string name="config_pdp_reject_service_not_subscribed" msgid="8190338397128671588"></string>

diff --git a/core/res/res/values/config.xml b/core/res/res/values/config.xml
index f4efcc7e..51b461e7 100644
--- a/core/res/res/values/config.xml
+++ b/core/res/res/values/config.xml
@@ -1654,6 +1654,8 @@
     <string-array name="config_locationProviderPackageNames" translatable="false">
         <!-- The standard AOSP fused location provider -->
         <item>com.android.location.fused</item>
+        <!-- Google Play Services or microG (free reimplementation) location provider -->
+        <item>com.google.android.gms</item>
     </string-array>

     <!-- This string array can be overriden to enable test location providers initially. -->

diff --git a/core/res/res/values/strings.xml b/core/res/res/values/strings.xml
index 5c659123..c2ab0d54 100644
--- a/core/res/res/values/strings.xml
+++ b/core/res/res/values/strings.xml
@@ -847,6 +847,17 @@

     <!--  Permissions -->

+    <!-- Title of an application permission, listed so the user can choose whether they want to allow the application to do this. -->
+    <string name="permlab_fakePackageSignature">Spoof package signature</string>
+    <!-- Description of an application permission, listed so the user can choose whether they want to allow the application to do this. -->
+    <string name="permdesc_fakePackageSignature">Allows the app to pretend to be a different app.</string>
+    <!-- Title of a category of application permissions, listed so the user can choose whether they want to allow the application to do this. -->
+    <string name="permgrouplab_fake_package_signature">Spoof package signature</string>
+    <!-- Description of a category of application permissions, listed so the user can choose whether they want to allow the application to do this. -->
+    <string name="permgroupdesc_fake_package_signature">pretend to be a different app</string>
+    <!-- Message shown to the user when the apps requests permission from this group. If ever possible this should stay below 80 characters (assuming the parameters takes 20 characters). Don't abbreviate until the message reaches 120 characters though. [CHAR LIMIT=120] -->
+    <string name="permgrouprequest_fake_package_signature">Allow &lt;b><xliff:g id="app_name" example="Gmail">%1$s</xliff:g>&lt;/b> to spoof package signature?</string>
+
     <!-- Title of an application permission, listed so the user can choose whether they want to allow the application to do this. -->
     <string name="permlab_statusBar">disable or modify status bar</string>
     <!-- Description of an application permission, listed so the user can choose whether they want to allow the application to do this. -->

diff --git a/data/fonts/fonts.xml b/data/fonts/fonts.xml
index 4c214b52..e2a9d8ca 100644
--- a/data/fonts/fonts.xml
+++ b/data/fonts/fonts.xml
@@ -576,20 +576,48 @@
         <font weight="400" style="normal">NotoSansSymbols-Regular-Subsetted.ttf</font>
     </family>
     <family lang="zh-Hans">
-        <font weight="400" style="normal" index="2">NotoSansCJK-Regular.ttc</font>
+        <font weight="100" style="normal" index="2">NotoSansCJK.ttc</font>
+        <font weight="300" style="normal" index="7">NotoSansCJK.ttc</font>
+        <font weight="350" style="normal" index="12">NotoSansCJK.ttc</font>
+        <font weight="400" style="normal" index="27">NotoSansCJK.ttc</font>
+        <font weight="500" style="normal" index="17">NotoSansCJK.ttc</font>
+        <font weight="700" style="normal" index="37">NotoSansCJK.ttc</font>
+        <font weight="900" style="normal" index="22">NotoSansCJK.ttc</font>
         <font weight="400" style="normal" index="2" fallbackFor="serif">NotoSerifCJK-Regular.ttc</font>
+        <font weight="700" style="normal" index="2" fallbackFor="serif">NotoSerifCJK-Bold.ttc</font>
     </family>
     <family lang="zh-Hant,zh-Bopo">
-        <font weight="400" style="normal" index="3">NotoSansCJK-Regular.ttc</font>
+        <font weight="100" style="normal" index="3">NotoSansCJK.ttc</font>
+        <font weight="300" style="normal" index="8">NotoSansCJK.ttc</font>
+        <font weight="350" style="normal" index="13">NotoSansCJK.ttc</font>
+        <font weight="400" style="normal" index="28">NotoSansCJK.ttc</font>
+        <font weight="500" style="normal" index="18">NotoSansCJK.ttc</font>
+        <font weight="700" style="normal" index="38">NotoSansCJK.ttc</font>
+        <font weight="900" style="normal" index="23">NotoSansCJK.ttc</font>
         <font weight="400" style="normal" index="3" fallbackFor="serif">NotoSerifCJK-Regular.ttc</font>
+        <font weight="700" style="normal" index="3" fallbackFor="serif">NotoSerifCJK-Bold.ttc</font>
     </family>
     <family lang="ja">
-        <font weight="400" style="normal" index="0">NotoSansCJK-Regular.ttc</font>
+        <font weight="100" style="normal" index="0">NotoSansCJK.ttc</font>
+        <font weight="300" style="normal" index="5">NotoSansCJK.ttc</font>
+        <font weight="350" style="normal" index="10">NotoSansCJK.ttc</font>
+        <font weight="400" style="normal" index="25">NotoSansCJK.ttc</font>
+        <font weight="500" style="normal" index="15">NotoSansCJK.ttc</font>
+        <font weight="700" style="normal" index="35">NotoSansCJK.ttc</font>
+        <font weight="900" style="normal" index="20">NotoSansCJK.ttc</font>
         <font weight="400" style="normal" index="0" fallbackFor="serif">NotoSerifCJK-Regular.ttc</font>
+        <font weight="700" style="normal" index="0" fallbackFor="serif">NotoSerifCJK-Bold.ttc</font>
     </family>
     <family lang="ko">
-        <font weight="400" style="normal" index="1">NotoSansCJK-Regular.ttc</font>
+        <font weight="100" style="normal" index="1">NotoSansCJK.ttc</font>
+        <font weight="300" style="normal" index="6">NotoSansCJK.ttc</font>
+        <font weight="350" style="normal" index="11">NotoSansCJK.ttc</font>
+        <font weight="400" style="normal" index="26">NotoSansCJK.ttc</font>
+        <font weight="500" style="normal" index="16">NotoSansCJK.ttc</font>
+        <font weight="700" style="normal" index="36">NotoSansCJK.ttc</font>
+        <font weight="900" style="normal" index="21">NotoSansCJK.ttc</font>
         <font weight="400" style="normal" index="1" fallbackFor="serif">NotoSerifCJK-Regular.ttc</font>
+        <font weight="700" style="normal" index="1" fallbackFor="serif">NotoSerifCJK-Bold.ttc</font>
     </family>
     <family lang="und-Zsye">
         <font weight="400" style="normal">NotoColorEmoji.ttf</font>

diff --git a/non-updatable-api/current.txt b/non-updatable-api/current.txt
index 5f15216e..6851cf14 100644
--- a/non-updatable-api/current.txt
+++ b/non-updatable-api/current.txt
@@ -79,6 +79,7 @@ package android {
     field public static final String DUMP = "android.permission.DUMP";
     field public static final String EXPAND_STATUS_BAR = "android.permission.EXPAND_STATUS_BAR";
     field public static final String FACTORY_TEST = "android.permission.FACTORY_TEST";
+    field public static final String FAKE_PACKAGE_SIGNATURE = "android.permission.FAKE_PACKAGE_SIGNATURE";
     field public static final String FOREGROUND_SERVICE = "android.permission.FOREGROUND_SERVICE";
     field public static final String GET_ACCOUNTS = "android.permission.GET_ACCOUNTS";
     field public static final String GET_ACCOUNTS_PRIVILEGED = "android.permission.GET_ACCOUNTS_PRIVILEGED";
@@ -182,6 +183,7 @@ package android {
     field public static final String CALL_LOG = "android.permission-group.CALL_LOG";
     field public static final String CAMERA = "android.permission-group.CAMERA";
     field public static final String CONTACTS = "android.permission-group.CONTACTS";
+    field public static final String FAKE_PACKAGE = "android.permission-group.FAKE_PACKAGE";
     field public static final String LOCATION = "android.permission-group.LOCATION";
     field public static final String MICROPHONE = "android.permission-group.MICROPHONE";
     field public static final String PHONE = "android.permission-group.PHONE";
@@ -80385,4 +80387,3 @@ package org.xmlpull.v1.sax2 {
   }

 }
-

diff --git a/services/core/Android.bp b/services/core/Android.bp
index 55e109e3..4ea3e988 100644
--- a/services/core/Android.bp
+++ b/services/core/Android.bp
@@ -110,11 +110,6 @@ java_library_static {
         "org.lineageos.platform.internal",
     ],

-    required: [
-        "gps_debug.conf",
-        "protolog.conf.json.gz",
-    ],
-
     static_libs: [
         "time_zone_distro",
         "time_zone_distro_installer",
@@ -169,11 +164,6 @@ java_library_host {
     srcs: ["java/com/android/server/notification/SmallHash.java"]
 }

-prebuilt_etc {
-    name: "gps_debug.conf",
-    src: "java/com/android/server/location/gps_debug.conf",
-}
-
 genrule {
     name: "services.core.json.gz",
     srcs: [":checked-protolog.json"],
@@ -181,8 +171,3 @@ genrule {
     cmd: "$(location minigzip) -c < $(in) > $(out)",
     tools: ["minigzip"],
 }
-
-prebuilt_etc {
-    name: "protolog.conf.json.gz",
-    src: ":services.core.json.gz",
-}

diff --git a/services/core/java/com/android/server/BatteryService.java b/services/core/java/com/android/server/BatteryService.java
index 27e8fd48..7ce06dc1 100644
--- a/services/core/java/com/android/server/BatteryService.java
+++ b/services/core/java/com/android/server/BatteryService.java
@@ -40,7 +40,6 @@ import android.os.BatteryProperty;
 import android.os.BatteryStats;
 import android.os.Binder;
 import android.os.Bundle;
-import android.os.DropBoxManager;
 import android.os.FileUtils;
 import android.os.Handler;
 import android.os.HandlerThread;
@@ -846,9 +845,6 @@ public final class BatteryService extends SystemService {
         IBinder batteryInfoService = ServiceManager.getService(BatteryStats.SERVICE_NAME);
         if (batteryInfoService == null) return;

-        DropBoxManager db = (DropBoxManager) mContext.getSystemService(Context.DROPBOX_SERVICE);
-        if (db == null || !db.isTagEnabled("BATTERY_DISCHARGE_INFO")) return;
-
         File dumpFile = null;
         FileOutputStream dumpStream = null;
         try {
@@ -857,9 +853,6 @@ public final class BatteryService extends SystemService {
             dumpStream = new FileOutputStream(dumpFile);
             batteryInfoService.dump(dumpStream.getFD(), DUMPSYS_ARGS);
             FileUtils.sync(dumpStream);
-
-            // add dump file to drop box
-            db.addFile("BATTERY_DISCHARGE_INFO", dumpFile, DropBoxManager.IS_TEXT);
         } catch (RemoteException e) {
             Slog.e(TAG, "failed to dump battery service", e);
         } catch (IOException e) {

diff --git a/services/core/java/com/android/server/DropBoxManagerService.java b/services/core/java/com/android/server/DropBoxManagerService.java
deleted file mode 100644
index 6560824f..00000000
--- a/services/core/java/com/android/server/DropBoxManagerService.java
+++ /dev/null

diff --git a/services/core/java/com/android/server/StorageManagerService.java b/services/core/java/com/android/server/StorageManagerService.java
index db8656ea..31921792 100644
--- a/services/core/java/com/android/server/StorageManagerService.java
+++ b/services/core/java/com/android/server/StorageManagerService.java
@@ -83,7 +83,6 @@ import android.content.res.ObbInfo;
 import android.database.ContentObserver;
 import android.net.Uri;
 import android.os.Binder;
-import android.os.DropBoxManager;
 import android.os.Environment;
 import android.os.Handler;
 import android.os.HandlerThread;
@@ -2349,10 +2348,6 @@ class StorageManagerService extends IStorageManager.Stub
                     final long run = extras.getLong("run");
                     final long destroy = extras.getLong("destroy");

-                    final DropBoxManager dropBox = mContext.getSystemService(DropBoxManager.class);
-                    dropBox.addText(TAG_STORAGE_BENCHMARK, scrubPath(path)
-                            + " " + ident + " " + create + " " + run + " " + destroy);
-
                     synchronized (mLock) {
                         final VolumeRecord rec = findRecordForPath(path);
                         if (rec != null) {
@@ -2512,9 +2507,6 @@ class StorageManagerService extends IStorageManager.Stub
                         final long bytes = extras.getLong("bytes");
                         final long time = extras.getLong("time");

-                        final DropBoxManager dropBox = mContext.getSystemService(DropBoxManager.class);
-                        dropBox.addText(TAG_STORAGE_TRIM, scrubPath(path) + " " + bytes + " " + time);
-
                         synchronized (mLock) {
                             final VolumeRecord rec = findRecordForPath(path);
                             if (rec != null) {

diff --git a/services/core/java/com/android/server/Watchdog.java b/services/core/java/com/android/server/Watchdog.java
index 425a0452..9b0f8c6b 100644
--- a/services/core/java/com/android/server/Watchdog.java
+++ b/services/core/java/com/android/server/Watchdog.java
@@ -657,27 +657,6 @@ public class Watchdog extends Thread {
             doSysRq('w');
             doSysRq('l');

-            // Try to add the error to the dropbox, but assuming that the ActivityManager
-            // itself may be deadlocked.  (which has happened, causing this statement to
-            // deadlock and the watchdog as a whole to be ineffective)
-            Thread dropboxThread = new Thread("watchdogWriteToDropbox") {
-                    public void run() {
-                        // If a watched thread hangs before init() is called, we don't have a
-                        // valid mActivity. So we can't log the error to dropbox.
-                        if (mActivity != null) {
-                            mActivity.addErrorToDropBox(
-                                    "watchdog", null, "system_server", null, null, null,
-                                    subject, report.toString(), stack, null);
-                        }
-                        FrameworkStatsLog.write(FrameworkStatsLog.SYSTEM_SERVER_WATCHDOG_OCCURRED,
-                                subject);
-                    }
-                };
-            dropboxThread.start();
-            try {
-                dropboxThread.join(2000);  // wait up to 2 seconds for it to return.
-            } catch (InterruptedException ignored) {}
-
             IActivityController controller;
             synchronized (this) {
                 controller = mController;

diff --git a/services/core/java/com/android/server/am/ActivityManagerService.java b/services/core/java/com/android/server/am/ActivityManagerService.java
index 0ae9cc27..f8442fa3 100644
--- a/services/core/java/com/android/server/am/ActivityManagerService.java
+++ b/services/core/java/com/android/server/am/ActivityManagerService.java
@@ -245,7 +245,6 @@ import android.os.BugreportParams;
 import android.os.Build;
 import android.os.Bundle;
 import android.os.Debug;
-import android.os.DropBoxManager;
 import android.os.FactoryTest;
 import android.os.FileUtils;
 import android.os.Handler;
@@ -494,8 +493,6 @@ public class ActivityManagerService extends IActivityManager.Stub

     static final String[] EMPTY_STRING_ARRAY = new String[0];

-    // How many bytes to write into the dropbox log before truncating
-    static final int DROPBOX_DEFAULT_MAX_SIZE = 192 * 1024;
     // Assumes logcat entries average around 100 bytes; that's not perfect stack traces count
     // as one line, but close enough for now.
     static final int RESERVED_BYTES_PER_LOGCAT_LINE = 100;
@@ -9881,9 +9878,6 @@ public class ActivityManagerService extends IActivityManager.Stub
             crashInfo.crashTag = crashInfo.crashTag + " " + relaunchReasonString;
         }

-        addErrorToDropBox(
-                eventType, r, processName, null, null, null, null, null, null, crashInfo);
-
         mAppErrors.crashApplication(r, crashInfo);
     }

@@ -9897,26 +9891,14 @@ public class ActivityManagerService extends IActivityManager.Stub

         if ((penaltyMask & StrictMode.PENALTY_DROPBOX) != 0) {
             Integer stackFingerprint = info.hashCode();
-            boolean logIt = true;
             synchronized (mAlreadyLoggedViolatedStacks) {
-                if (mAlreadyLoggedViolatedStacks.contains(stackFingerprint)) {
-                    logIt = false;
-                    // TODO: sub-sample into EventLog for these, with
-                    // the info.durationMillis?  Then we'd get
-                    // the relative pain numbers, without logging all
-                    // the stack traces repeatedly.  We'd want to do
-                    // likewise in the client code, which also does
-                    // dup suppression, before the Binder call.
-                } else {
+                if (!mAlreadyLoggedViolatedStacks.contains(stackFingerprint)) {
                     if (mAlreadyLoggedViolatedStacks.size() >= MAX_DUP_SUPPRESSED_STACKS) {
                         mAlreadyLoggedViolatedStacks.clear();
                     }
                     mAlreadyLoggedViolatedStacks.add(stackFingerprint);
                 }
             }
-            if (logIt) {
-                logStrictModeViolationToDropBox(r, info);
-            }
         }

         if ((penaltyMask & StrictMode.PENALTY_DIALOG) != 0) {
@@ -9940,68 +9922,6 @@ public class ActivityManagerService extends IActivityManager.Stub
         }
     }

-    // Depending on the policy in effect, there could be a bunch of
-    // these in quick succession so we try to batch these together to
-    // minimize disk writes, number of dropbox entries, and maximize
-    // compression, by having more fewer, larger records.
-    private void logStrictModeViolationToDropBox(
-            ProcessRecord process,
-            StrictMode.ViolationInfo info) {
-        if (info == null) {
-            return;
-        }
-        final boolean isSystemApp = process == null ||
-                (process.info.flags & (ApplicationInfo.FLAG_SYSTEM |
-                                       ApplicationInfo.FLAG_UPDATED_SYSTEM_APP)) != 0;
-        final String processName = process == null ? "unknown" : process.processName;
-        final DropBoxManager dbox = (DropBoxManager)
-                mContext.getSystemService(Context.DROPBOX_SERVICE);
-
-        // Exit early if the dropbox isn't configured to accept this report type.
-        final String dropboxTag = processClass(process) + "_strictmode";
-        if (dbox == null || !dbox.isTagEnabled(dropboxTag)) return;
-
-        final StringBuilder sb = new StringBuilder(1024);
-        synchronized (sb) {
-            appendDropBoxProcessHeaders(process, processName, sb);
-            sb.append("Build: ").append(Build.FINGERPRINT).append("\n");
-            sb.append("System-App: ").append(isSystemApp).append("\n");
-            sb.append("Uptime-Millis: ").append(info.violationUptimeMillis).append("\n");
-            if (info.violationNumThisLoop != 0) {
-                sb.append("Loop-Violation-Number: ").append(info.violationNumThisLoop).append("\n");
-            }
-            if (info.numAnimationsRunning != 0) {
-                sb.append("Animations-Running: ").append(info.numAnimationsRunning).append("\n");
-            }
-            if (info.broadcastIntentAction != null) {
-                sb.append("Broadcast-Intent-Action: ").append(info.broadcastIntentAction).append("\n");
-            }
-            if (info.durationMillis != -1) {
-                sb.append("Duration-Millis: ").append(info.durationMillis).append("\n");
-            }
-            if (info.numInstances != -1) {
-                sb.append("Instance-Count: ").append(info.numInstances).append("\n");
-            }
-            if (info.tags != null) {
-                for (String tag : info.tags) {
-                    sb.append("Span-Tag: ").append(tag).append("\n");
-                }
-            }
-            sb.append("\n");
-            sb.append(info.getStackTrace());
-            sb.append("\n");
-            if (info.getViolationDetails() != null) {
-                sb.append(info.getViolationDetails());
-                sb.append("\n");
-            }
-        }
-
-        final String res = sb.toString();
-        IoThread.getHandler().post(() -> {
-            dbox.addText(dropboxTag, res);
-        });
-    }
-
     /**
      * Used by {@link Log} via {@link com.android.internal.os.RuntimeInit} to report serious errors.
      * @param app object of the crashing app, null for the system server
@@ -10060,35 +9980,9 @@ public class ActivityManagerService extends IActivityManager.Stub
         FrameworkStatsLog.write(FrameworkStatsLog.WTF_OCCURRED, callingUid, tag, processName,
                 callingPid, (r != null) ? r.getProcessClassEnum() : 0);

-        addErrorToDropBox("wtf", r, processName, null, null, null, tag, null, null, crashInfo);
-
         return r;
     }

-    /**
-     * Schedule to handle any pending system_server WTFs.
-     */
-    public void schedulePendingSystemServerWtfs(
-            final LinkedList<Pair<String, ApplicationErrorReport.CrashInfo>> list) {
-        mHandler.post(() -> handlePendingSystemServerWtfs(list));
-    }
-
-    /**
-     * Handle any pending system_server WTFs, add into the dropbox
-     */
-    private void handlePendingSystemServerWtfs(
-            final LinkedList<Pair<String, ApplicationErrorReport.CrashInfo>> list) {
-        ProcessRecord proc;
-        synchronized (mPidsSelfLocked) {
-            proc = mPidsSelfLocked.get(MY_PID);
-        }
-        for (Pair<String, ApplicationErrorReport.CrashInfo> p = list.poll();
-                p != null; p = list.poll()) {
-            addErrorToDropBox("wtf", proc, "system_server", null, null, null, p.first, null, null,
-                    p.second);
-        }
-    }
-
     /**
      * @param app object of some object (as stored in {@link com.android.internal.os.RuntimeInit})
      * @return the corresponding {@link ProcessRecord} object, or null if none could be found
@@ -10103,54 +9997,6 @@ public class ActivityManagerService extends IActivityManager.Stub
         }
     }

-    /**
-     * Utility function for addErrorToDropBox and handleStrictModeViolation's logging
-     * to append various headers to the dropbox log text.
-     */
-    void appendDropBoxProcessHeaders(ProcessRecord process, String processName,
-            StringBuilder sb) {
-        // Watchdog thread ends up invoking this function (with
-        // a null ProcessRecord) to add the stack file to dropbox.
-        // Do not acquire a lock on this (am) in such cases, as it
-        // could cause a potential deadlock, if and when watchdog
-        // is invoked due to unavailability of lock on am and it
-        // would prevent watchdog from killing system_server.
-        if (process == null) {
-            sb.append("Process: ").append(processName).append("\n");
-            return;
-        }
-        // Note: ProcessRecord 'process' is guarded by the service
-        // instance.  (notably process.pkgList, which could otherwise change
-        // concurrently during execution of this method)
-        synchronized (this) {
-            sb.append("Process: ").append(processName).append("\n");
-            sb.append("PID: ").append(process.pid).append("\n");
-            sb.append("UID: ").append(process.uid).append("\n");
-            int flags = process.info.flags;
-            IPackageManager pm = AppGlobals.getPackageManager();
-            sb.append("Flags: 0x").append(Integer.toHexString(flags)).append("\n");
-            for (int ip=0; ip<process.pkgList.size(); ip++) {
-                String pkg = process.pkgList.keyAt(ip);
-                sb.append("Package: ").append(pkg);
-                try {
-                    PackageInfo pi = pm.getPackageInfo(pkg, 0, UserHandle.getCallingUserId());
-                    if (pi != null) {
-                        sb.append(" v").append(pi.getLongVersionCode());
-                        if (pi.versionName != null) {
-                            sb.append(" (").append(pi.versionName).append(")");
-                        }
-                    }
-                } catch (RemoteException e) {
-                    Slog.e(TAG, "Error getting package info: " + pkg, e);
-                }
-                sb.append("\n");
-            }
-            if (process.info.isInstantApp()) {
-                sb.append("Instant-App: true\n");
-            }
-        }
-    }
-
     private static String processClass(ProcessRecord process) {
         if (process == null || process.pid == MY_PID) {
             return "system_server";
@@ -10163,158 +10009,6 @@ public class ActivityManagerService extends IActivityManager.Stub

     private final ArrayMap<String, long[]> mErrorClusterRecords = new ArrayMap<>();

-    /**
-     * Write a description of an error (crash, WTF, ANR) to the drop box.
-     * @param eventType to include in the drop box tag ("crash", "wtf", etc.)
-     * @param process which caused the error, null means the system server
-     * @param activityShortComponentName which triggered the error, null if unknown
-     * @param parentShortComponentName activity related to the error, null if unknown
-     * @param parentProcess parent process
-     * @param subject line related to the error, null if absent
-     * @param report in long form describing the error, null if absent
-     * @param dataFile text file to include in the report, null if none
-     * @param crashInfo giving an application stack trace, null if absent
-     */
-    public void addErrorToDropBox(String eventType,
-            ProcessRecord process, String processName, String activityShortComponentName,
-            String parentShortComponentName, ProcessRecord parentProcess,
-            String subject, final String report, final File dataFile,
-            final ApplicationErrorReport.CrashInfo crashInfo) {
-        // NOTE -- this must never acquire the ActivityManagerService lock,
-        // otherwise the watchdog may be prevented from resetting the system.
-
-        // Bail early if not published yet
-        if (ServiceManager.getService(Context.DROPBOX_SERVICE) == null) return;
-        final DropBoxManager dbox = mContext.getSystemService(DropBoxManager.class);
-
-        // Exit early if the dropbox isn't configured to accept this report type.
-        final String dropboxTag = processClass(process) + "_" + eventType;
-        if (dbox == null || !dbox.isTagEnabled(dropboxTag)) return;
-
-        // Rate-limit how often we're willing to do the heavy lifting below to
-        // collect and record logs; currently 5 logs per 10 second period per eventType.
-        final long now = SystemClock.elapsedRealtime();
-        synchronized (mErrorClusterRecords) {
-            long[] errRecord = mErrorClusterRecords.get(eventType);
-            if (errRecord == null) {
-                errRecord = new long[2]; // [0]: startTime, [1]: count
-                mErrorClusterRecords.put(eventType, errRecord);
-            }
-            if (now - errRecord[0] > 10 * DateUtils.SECOND_IN_MILLIS) {
-                errRecord[0] = now;
-                errRecord[1] = 1L;
-            } else {
-                if (errRecord[1]++ >= 5) return;
-            }
-        }
-
-        final StringBuilder sb = new StringBuilder(1024);
-        appendDropBoxProcessHeaders(process, processName, sb);
-        if (process != null) {
-            sb.append("Foreground: ")
-                    .append(process.isInterestingToUserLocked() ? "Yes" : "No")
-                    .append("\n");
-            if (process.startTime > 0) {
-                long runtimeMillis = SystemClock.elapsedRealtime() - process.startTime;
-                sb.append("Process-Runtime: ").append(runtimeMillis).append("\n");
-            }
-        }
-        if (activityShortComponentName != null) {
-            sb.append("Activity: ").append(activityShortComponentName).append("\n");
-        }
-        if (parentShortComponentName != null) {
-            if (parentProcess != null && parentProcess.pid != process.pid) {
-                sb.append("Parent-Process: ").append(parentProcess.processName).append("\n");
-            }
-            if (!parentShortComponentName.equals(activityShortComponentName)) {
-                sb.append("Parent-Activity: ").append(parentShortComponentName).append("\n");
-            }
-        }
-        if (subject != null) {
-            sb.append("Subject: ").append(subject).append("\n");
-        }
-        sb.append("Build: ").append(Build.FINGERPRINT).append("\n");
-        if (Debug.isDebuggerConnected()) {
-            sb.append("Debugger: Connected\n");
-        }
-        if (crashInfo != null && crashInfo.crashTag != null && !crashInfo.crashTag.isEmpty()) {
-            sb.append("Crash-Tag: ").append(crashInfo.crashTag).append("\n");
-        }
-        sb.append("\n");
-
-        // Do the rest in a worker thread to avoid blocking the caller on I/O
-        // (After this point, we shouldn't access AMS internal data structures.)
-        Thread worker = new Thread("Error dump: " + dropboxTag) {
-            @Override
-            public void run() {
-                if (report != null) {
-                    sb.append(report);
-                }
-
-                String logcatSetting = Settings.Global.ERROR_LOGCAT_PREFIX + dropboxTag;
-                String maxBytesSetting = Settings.Global.MAX_ERROR_BYTES_PREFIX + dropboxTag;
-                int lines = Settings.Global.getInt(mContext.getContentResolver(), logcatSetting, 0);
-                int dropboxMaxSize = Settings.Global.getInt(
-                        mContext.getContentResolver(), maxBytesSetting, DROPBOX_DEFAULT_MAX_SIZE);
-                int maxDataFileSize = dropboxMaxSize - sb.length()
-                        - lines * RESERVED_BYTES_PER_LOGCAT_LINE;
-
-                if (dataFile != null && maxDataFileSize > 0) {
-                    try {
-                        sb.append(FileUtils.readTextFile(dataFile, maxDataFileSize,
-                                    "\n\n[[TRUNCATED]]"));
-                    } catch (IOException e) {
-                        Slog.e(TAG, "Error reading " + dataFile, e);
-                    }
-                }
-                if (crashInfo != null && crashInfo.stackTrace != null) {
-                    sb.append(crashInfo.stackTrace);
-                }
-
-                if (lines > 0) {
-                    sb.append("\n");
-
-                    // Merge several logcat streams, and take the last N lines
-                    InputStreamReader input = null;
-                    try {
-                        java.lang.Process logcat = new ProcessBuilder(
-                                "/system/bin/timeout", "-k", "15s", "10s",
-                                "/system/bin/logcat", "-v", "threadtime", "-b", "events", "-b", "system",
-                                "-b", "main", "-b", "crash", "-t", String.valueOf(lines))
-                                        .redirectErrorStream(true).start();
-
-                        try { logcat.getOutputStream().close(); } catch (IOException e) {}
-                        try { logcat.getErrorStream().close(); } catch (IOException e) {}
-                        input = new InputStreamReader(logcat.getInputStream());
-
-                        int num;
-                        char[] buf = new char[8192];
-                        while ((num = input.read(buf)) > 0) sb.append(buf, 0, num);
-                    } catch (IOException e) {
-                        Slog.e(TAG, "Error running logcat", e);
-                    } finally {
-                        if (input != null) try { input.close(); } catch (IOException e) {}
-                    }
-                }
-
-                dbox.addText(dropboxTag, sb.toString());
-            }
-        };
-
-        if (process == null) {
-            // If process is null, we are being called from some internal code
-            // and may be about to die -- run this synchronously.
-            final int oldMask = StrictMode.allowThreadDiskWritesMask();
-            try {
-                worker.run();
-            } finally {
-                StrictMode.setThreadPolicyMask(oldMask);
-            }
-        } else {
-            worker.start();
-        }
-    }
-
     @Override
     public List<ActivityManager.ProcessErrorStateInfo> getProcessesInErrorState() {
         enforceNotIsolatedCaller("getProcessesInErrorState");
@@ -14616,10 +14310,6 @@ public class ActivityManagerService extends IActivityManager.Stub
         }
         dropBuilder.append(catSw.toString());
         FrameworkStatsLog.write(FrameworkStatsLog.LOW_MEM_REPORTED);
-        addErrorToDropBox("lowmem", null, "system_server", null,
-                null, null, tag.toString(), dropBuilder.toString(), null, null);
-        //Slog.i(TAG, "Sent to dropbox:");
-        //Slog.i(TAG, dropBuilder.toString());
         synchronized (ActivityManagerService.this) {
             long now = SystemClock.uptimeMillis();
             if (mLastMemUsageReportTime < now) {

diff --git a/services/core/java/com/android/server/am/ProcessList.java b/services/core/java/com/android/server/am/ProcessList.java
index f1e4ae5c..9b17c563 100644
--- a/services/core/java/com/android/server/am/ProcessList.java
+++ b/services/core/java/com/android/server/am/ProcessList.java
@@ -79,7 +79,6 @@ import android.os.AppZygote;
 import android.os.Binder;
 import android.os.Build;
 import android.os.Bundle;
-import android.os.DropBoxManager;
 import android.os.Handler;
 import android.os.IBinder;
 import android.os.Looper;
@@ -3963,8 +3962,6 @@ public final class ProcessList {
         private static final String EXTRA_REASON = "reason";
         private static final String EXTRA_REQUESTER = "requester";

-        private static final String DROPBOX_TAG_IMPERCEPTIBLE_KILL = "imperceptible_app_kill";
-
         // uid -> killing information mapping
         private SparseArray<List<Bundle>> mWorkItems = new SparseArray<List<Bundle>>();

@@ -4067,10 +4064,6 @@ public final class ProcessList {
         }

         private void handleDeviceIdle() {
-            final DropBoxManager dbox = mService.mContext.getSystemService(DropBoxManager.class);
-            final boolean logToDropbox = dbox != null
-                    && dbox.isTagEnabled(DROPBOX_TAG_IMPERCEPTIBLE_KILL);
-
             synchronized (mService) {
                 final int size = mWorkItems.size();
                 for (int i = size - 1; mIdle && i >= 0; i--) {
@@ -4083,8 +4076,7 @@ public final class ProcessList {
                                 bundle.getInt(EXTRA_UID),
                                 bundle.getLong(EXTRA_TIMESTAMP),
                                 bundle.getString(EXTRA_REASON),
-                                bundle.getInt(EXTRA_REQUESTER),
-                                dbox, logToDropbox)) {
+                                bundle.getInt(EXTRA_REQUESTER))) {
                             list.remove(j);
                         }
                     }
@@ -4118,8 +4110,7 @@ public final class ProcessList {
          */
         @GuardedBy("mService")
         private boolean killProcessLocked(final int pid, final int uid, final long timestamp,
-                final String reason, final int requester, final DropBoxManager dbox,
-                final boolean logToDropbox) {
+                final String reason, final int requester) {
             ProcessRecord app = null;
             synchronized (mService.mPidsSelfLocked) {
                 app = mService.mPidsSelfLocked.get(pid);
@@ -4153,21 +4144,10 @@ public final class ProcessList {
                 mLastProcessKillTimes.put(app.processName, app.uid, SystemClock.uptimeMillis());
             }

-            if (logToDropbox) {
-                final long now = SystemClock.elapsedRealtime();
-                final StringBuilder sb = new StringBuilder();
-                mService.appendDropBoxProcessHeaders(app, app.processName, sb);
-                sb.append("Reason: " + reason).append("\n");
-                sb.append("Requester UID: " + requester).append("\n");
-                dbox.addText(DROPBOX_TAG_IMPERCEPTIBLE_KILL, sb.toString());
-            }
             return true;
         }

         private void handleUidStateChanged(int uid, int procState) {
-            final DropBoxManager dbox = mService.mContext.getSystemService(DropBoxManager.class);
-            final boolean logToDropbox = dbox != null
-                    && dbox.isTagEnabled(DROPBOX_TAG_IMPERCEPTIBLE_KILL);
             synchronized (mService) {
                 if (mIdle && !mService.mConstants
                         .IMPERCEPTIBLE_KILL_EXEMPT_PROC_STATES.contains(procState)) {
@@ -4181,8 +4161,7 @@ public final class ProcessList {
                                     bundle.getInt(EXTRA_UID),
                                     bundle.getLong(EXTRA_TIMESTAMP),
                                     bundle.getString(EXTRA_REASON),
-                                    bundle.getInt(EXTRA_REQUESTER),
-                                    dbox, logToDropbox)) {
+                                    bundle.getInt(EXTRA_REQUESTER))) {
                                 list.remove(j);
                             }
                         }

diff --git a/services/core/java/com/android/server/am/ProcessRecord.java b/services/core/java/com/android/server/am/ProcessRecord.java
index 284903d3..479eabec 100644
--- a/services/core/java/com/android/server/am/ProcessRecord.java
+++ b/services/core/java/com/android/server/am/ProcessRecord.java
@@ -1751,9 +1751,6 @@ class ProcessRecord implements WindowProcessListener {
                 (this.info != null) ? this.info.packageName : "");
         final ProcessRecord parentPr = parentProcess != null
                 ? (ProcessRecord) parentProcess.mOwner : null;
-        mService.addErrorToDropBox("anr", this, processName, activityShortComponentName,
-                parentShortComponentName, parentPr, annotation, report.toString(), tracesFile,
-                null);

         if (mWindowProcessController.appNotResponding(info.toString(), () -> kill("anr",
                 ApplicationExitInfo.REASON_ANR, true),

diff --git a/services/core/java/com/android/server/location/gnss/GnssConfiguration.java b/services/core/java/com/android/server/location/gnss/GnssConfiguration.java
index 14ab79e7..e6611071 100644
--- a/services/core/java/com/android/server/location/gnss/GnssConfiguration.java
+++ b/services/core/java/com/android/server/location/gnss/GnssConfiguration.java
@@ -53,8 +53,6 @@ class GnssConfiguration {

     private static final boolean DEBUG = Log.isLoggable(TAG, Log.DEBUG);

-    private static final String DEBUG_PROPERTIES_FILE = "/etc/gps_debug.conf";
-
     // config.xml properties
     private static final String CONFIG_SUPL_HOST = "SUPL_HOST";
     private static final String CONFIG_SUPL_PORT = "SUPL_PORT";
@@ -227,10 +225,6 @@ class GnssConfiguration {
             // override default value of this if lpp_prof is not empty
             mProperties.setProperty(CONFIG_LPP_PROFILE, lpp_prof);
         }
-        /*
-         * Overlay carrier properties from a debug configuration file.
-         */
-        loadPropertiesFromGpsDebugConfig(mProperties);

         mEsExtensionSec = getRangeCheckedConfigEsExtensionSec();

@@ -337,21 +331,6 @@ class GnssConfiguration {
         }
     }

-    private void loadPropertiesFromGpsDebugConfig(Properties properties) {
-        try {
-            File file = new File(DEBUG_PROPERTIES_FILE);
-            FileInputStream stream = null;
-            try {
-                stream = new FileInputStream(file);
-                properties.load(stream);
-            } finally {
-                IoUtils.closeQuietly(stream);
-            }
-        } catch (IOException e) {
-            if (DEBUG) Log.d(TAG, "Could not open GPS configuration file " + DEBUG_PROPERTIES_FILE);
-        }
-    }
-
     private int getRangeCheckedConfigEsExtensionSec() {
         int emergencyExtensionSeconds = getIntConfig(CONFIG_ES_EXTENSION_SEC, 0);
         if (emergencyExtensionSeconds > MAX_EMERGENCY_MODE_EXTENSION_SECONDS) {

diff --git a/services/core/java/com/android/server/location/gps_debug.conf b/services/core/java/com/android/server/location/gps_debug.conf
deleted file mode 100644
index 34ce96f3..00000000
--- a/services/core/java/com/android/server/location/gps_debug.conf
+++ /dev/null

diff --git a/services/core/java/com/android/server/net/NetworkStatsRecorder.java b/services/core/java/com/android/server/net/NetworkStatsRecorder.java
index 9eff5d16..3b180014 100644
--- a/services/core/java/com/android/server/net/NetworkStatsRecorder.java
+++ b/services/core/java/com/android/server/net/NetworkStatsRecorder.java
@@ -27,7 +27,6 @@ import android.net.NetworkStatsHistory;
 import android.net.NetworkTemplate;
 import android.net.TrafficStats;
 import android.os.Binder;
-import android.os.DropBoxManager;
 import android.service.NetworkStatsRecorderProto;
 import android.util.Log;
 import android.util.MathUtils;
@@ -73,8 +72,6 @@ public class NetworkStatsRecorder {
     private static final boolean DUMP_BEFORE_DELETE = true;

     private final FileRotator mRotator;
-    private final NonMonotonicObserver<String> mObserver;
-    private final DropBoxManager mDropBox;
     private final String mCookie;

     private final long mBucketDuration;
@@ -95,8 +92,6 @@ public class NetworkStatsRecorder {
      */
     public NetworkStatsRecorder() {
         mRotator = null;
-        mObserver = null;
-        mDropBox = null;
         mCookie = null;

         // set the bucket big enough to have all data in one bucket, but allow some
@@ -113,11 +108,8 @@ public class NetworkStatsRecorder {
     /**
      * Persisted recorder.
      */
-    public NetworkStatsRecorder(FileRotator rotator, NonMonotonicObserver<String> observer,
-            DropBoxManager dropBox, String cookie, long bucketDuration, boolean onlyTags) {
+    public NetworkStatsRecorder(FileRotator rotator, String cookie, long bucketDuration, boolean onlyTags) {
         mRotator = Objects.requireNonNull(rotator, "missing FileRotator");
-        mObserver = Objects.requireNonNull(observer, "missing NonMonotonicObserver");
-        mDropBox = Objects.requireNonNull(dropBox, "missing DropBoxManager");
         mCookie = cookie;

         mBucketDuration = bucketDuration;
@@ -219,7 +211,7 @@ public class NetworkStatsRecorder {
         final NetworkStatsCollection complete = mComplete != null ? mComplete.get() : null;

         final NetworkStats delta = NetworkStats.subtract(
-                snapshot, mLastSnapshot, mObserver, mCookie);
+                snapshot, mLastSnapshot, null, mCookie);
         final long end = currentTimeMillis;
         final long start = end - delta.getElapsedRealtime();

@@ -230,9 +222,6 @@ public class NetworkStatsRecorder {
             // As a last-ditch sanity check, report any negative values and
             // clamp them so recording below doesn't croak.
             if (entry.isNegative()) {
-                if (mObserver != null) {
-                    mObserver.foundNonMonotonic(delta, i, mCookie);
-                }
                 entry.rxBytes = Math.max(entry.rxBytes, 0);
                 entry.rxPackets = Math.max(entry.rxPackets, 0);
                 entry.txBytes = Math.max(entry.txBytes, 0);
@@ -498,7 +487,6 @@ public class NetworkStatsRecorder {
             } finally {
                 IoUtils.closeQuietly(os);
             }
-            mDropBox.addData(TAG_NETSTATS_DUMP, os.toByteArray(), 0);
         }

         mRotator.deleteAll();

diff --git a/services/core/java/com/android/server/net/NetworkStatsService.java b/services/core/java/com/android/server/net/NetworkStatsService.java
index ba9f4860..9b001fe4 100644
--- a/services/core/java/com/android/server/net/NetworkStatsService.java
+++ b/services/core/java/com/android/server/net/NetworkStatsService.java
@@ -108,7 +108,6 @@ import android.net.netstats.provider.INetworkStatsProviderCallback;
 import android.net.netstats.provider.NetworkStatsProvider;
 import android.os.BestClock;
 import android.os.Binder;
-import android.os.DropBoxManager;
 import android.os.Environment;
 import android.os.Handler;
 import android.os.HandlerExecutor;
@@ -294,9 +293,6 @@ public class NetworkStatsService extends INetworkStatsService.Stub {
     @Nullable
     private NetworkState[] mLastNetworkStates = null;

-    private final DropBoxNonMonotonicObserver mNonMonotonicObserver =
-            new DropBoxNonMonotonicObserver();
-
     private static final int MAX_STATS_PROVIDER_POLL_WAIT_TIME_MS = 100;
     private final CopyOnWriteArrayList<NetworkStatsProviderCallbackImpl> mStatsProviderCbList =
             new CopyOnWriteArrayList<>();
@@ -541,11 +537,9 @@ public class NetworkStatsService extends INetworkStatsService.Stub {

     private NetworkStatsRecorder buildRecorder(
             String prefix, NetworkStatsSettings.Config config, boolean includeTags) {
-        final DropBoxManager dropBox = (DropBoxManager) mContext.getSystemService(
-                Context.DROPBOX_SERVICE);
         return new NetworkStatsRecorder(new FileRotator(
                 mBaseDir, prefix, config.rotateAgeMillis, config.deleteAgeMillis),
-                mNonMonotonicObserver, dropBox, prefix, config.bucketDuration, includeTags);
+                prefix, config.bucketDuration, includeTags);
     }

     @GuardedBy("mStatsLock")
@@ -2077,37 +2071,6 @@ public class NetworkStatsService extends INetworkStatsService.Stub {
         }
     }

-    private class DropBoxNonMonotonicObserver implements NonMonotonicObserver<String> {
-        @Override
-        public void foundNonMonotonic(NetworkStats left, int leftIndex, NetworkStats right,
-                int rightIndex, String cookie) {
-            Log.w(TAG, "Found non-monotonic values; saving to dropbox");
-
-            // record error for debugging
-            final StringBuilder builder = new StringBuilder();
-            builder.append("found non-monotonic " + cookie + " values at left[" + leftIndex
-                    + "] - right[" + rightIndex + "]\n");
-            builder.append("left=").append(left).append('\n');
-            builder.append("right=").append(right).append('\n');
-
-            mContext.getSystemService(DropBoxManager.class).addText(TAG_NETSTATS_ERROR,
-                    builder.toString());
-        }
-
-        @Override
-        public void foundNonMonotonic(
-                NetworkStats stats, int statsIndex, String cookie) {
-            Log.w(TAG, "Found non-monotonic values; saving to dropbox");
-
-            final StringBuilder builder = new StringBuilder();
-            builder.append("Found non-monotonic " + cookie + " values at [" + statsIndex + "]\n");
-            builder.append("stats=").append(stats).append('\n');
-
-            mContext.getSystemService(DropBoxManager.class).addText(TAG_NETSTATS_ERROR,
-                    builder.toString());
-        }
-    }
-
     /**
      * Default external settings that read from
      * {@link android.provider.Settings.Global}.

diff --git a/services/core/java/com/android/server/net/watchlist/WatchlistLoggingHandler.java b/services/core/java/com/android/server/net/watchlist/WatchlistLoggingHandler.java
index 5599b0c0..86b07535 100644
--- a/services/core/java/com/android/server/net/watchlist/WatchlistLoggingHandler.java
+++ b/services/core/java/com/android/server/net/watchlist/WatchlistLoggingHandler.java
@@ -26,7 +26,6 @@ import android.content.pm.PackageManager;
 import android.content.pm.PackageManager.NameNotFoundException;
 import android.content.pm.UserInfo;
 import android.os.Bundle;
-import android.os.DropBoxManager;
 import android.os.Handler;
 import android.os.Looper;
 import android.os.Message;
@@ -68,10 +67,8 @@ class WatchlistLoggingHandler extends Handler {
     static final int FORCE_REPORT_RECORDS_NOW_FOR_TEST_MSG = 3;

     private static final long ONE_DAY_MS = TimeUnit.DAYS.toMillis(1);
-    private static final String DROPBOX_TAG = "network_watchlist_report";

     private final Context mContext;
-    private final @Nullable DropBoxManager mDropBoxManager;
     private final ContentResolver mResolver;
     private final PackageManager mPm;
     private final WatchlistReportDbHelper mDbHelper;
@@ -99,7 +96,6 @@ class WatchlistLoggingHandler extends Handler {
         mDbHelper = WatchlistReportDbHelper.getInstance(context);
         mConfig = WatchlistConfig.getInstance();
         mSettings = WatchlistSettings.getInstance();
-        mDropBoxManager = mContext.getSystemService(DropBoxManager.class);
         mPrimaryUserId = getPrimaryUserId();
     }

@@ -261,29 +257,6 @@ class WatchlistLoggingHandler extends Handler {
                 Slog.i(TAG, "No need to aggregate record yet.");
                 return;
             }
-            Slog.i(TAG, "Start aggregating watchlist records.");
-            if (mDropBoxManager != null && mDropBoxManager.isTagEnabled(DROPBOX_TAG)) {
-                Settings.Global.putLong(mResolver,
-                        Settings.Global.NETWORK_WATCHLIST_LAST_REPORT_TIME,
-                        lastRecordTime);
-                final WatchlistReportDbHelper.AggregatedResult aggregatedResult =
-                        mDbHelper.getAggregatedRecords(lastRecordTime);
-                if (aggregatedResult == null) {
-                    Slog.i(TAG, "Cannot get result from database");
-                    return;
-                }
-                // Get all digests for watchlist report, it should include all installed
-                // application digests and previously recorded app digests.
-                final List<String> digestsForReport = getAllDigestsForReport(aggregatedResult);
-                final byte[] secretKey = mSettings.getPrivacySecretKey();
-                final byte[] encodedResult = ReportEncoder.encodeWatchlistReport(mConfig,
-                        secretKey, digestsForReport, aggregatedResult);
-                if (encodedResult != null) {
-                    addEncodedReportToDropBox(encodedResult);
-                }
-            } else {
-                Slog.w(TAG, "Network Watchlist dropbox tag is not enabled");
-            }
             mDbHelper.cleanup(lastRecordTime);
         } finally {
             long endTime = System.currentTimeMillis();
@@ -316,10 +289,6 @@ class WatchlistLoggingHandler extends Handler {
         return new ArrayList<>(result);
     }

-    private void addEncodedReportToDropBox(byte[] encodedReport) {
-        mDropBoxManager.addData(DROPBOX_TAG, encodedReport, 0);
-    }
-
     /**
      * Get app digest from app uid.
      * Return null if system cannot get digest from uid.

diff --git a/services/core/java/com/android/server/pm/PackageManagerService.java b/services/core/java/com/android/server/pm/PackageManagerService.java
index 70b869e5..2384354e 100644
--- a/services/core/java/com/android/server/pm/PackageManagerService.java
+++ b/services/core/java/com/android/server/pm/PackageManagerService.java
@@ -4454,8 +4454,8 @@ public class PackageManagerService extends IPackageManager.Stub
                 });
             }

-            PackageInfo packageInfo = PackageInfoUtils.generate(p, gids, flags,
-                    ps.firstInstallTime, ps.lastUpdateTime, permissions, state, userId, ps);
+            PackageInfo packageInfo = mayFakeSignature(p, PackageInfoUtils.generate(p, gids, flags,
+                    ps.firstInstallTime, ps.lastUpdateTime, permissions, state, userId, ps), permissions);

             if (packageInfo == null) {
                 return null;
@@ -4491,6 +4491,23 @@ public class PackageManagerService extends IPackageManager.Stub
         }
     }

+    private PackageInfo mayFakeSignature(AndroidPackage p, PackageInfo pi, Set<String> permissions) {
+        try {
+            if (permissions.contains("android.permission.FAKE_PACKAGE_SIGNATURE")
+                    && p.getTargetSdkVersion() > Build.VERSION_CODES.LOLLIPOP_MR1
+                    && p.getMetaData() != null) {
+                String sig = p.getMetaData().getString("fake-signature");
+                if (sig != null) {
+                    pi.signatures = new Signature[] {new Signature(sig)};
+                }
+            }
+        } catch (Throwable t) {
+            // We should never die because of any failures, this is system code!
+            Log.w("PackageManagerService.FAKE_PACKAGE_SIGNATURE", t);
+        }
+        return pi;
+    }
+
     @Override
     public void checkPackageStartable(String packageName, int userId) {
         final int callingUid = Binder.getCallingUid();

diff --git a/services/core/java/com/android/server/protolog/ProtoLogImpl.java b/services/core/java/com/android/server/protolog/ProtoLogImpl.java
index c9d42c85..e1fb1a13 100644
--- a/services/core/java/com/android/server/protolog/ProtoLogImpl.java
+++ b/services/core/java/com/android/server/protolog/ProtoLogImpl.java
@@ -127,7 +127,6 @@ public class ProtoLogImpl {

     private static final int BUFFER_CAPACITY = 1024 * 1024;
     private static final String LOG_FILENAME = "/data/misc/wmtrace/wm_log.pb";
-    private static final String VIEWER_CONFIG_FILENAME = "/system/etc/protolog.conf.json.gz";
     private static final String TAG = "ProtoLog";
     private static final long MAGIC_NUMBER_VALUE = ((long) MAGIC_NUMBER_H << 32) | MAGIC_NUMBER_L;
     static final String PROTOLOG_VERSION = "1.0.0";
@@ -400,7 +399,6 @@ public class ProtoLogImpl {
             case "enable":
                 return setLogging(shell, false, true);
             case "enable-text":
-                mViewerConfig.loadViewerConfig(pw, VIEWER_CONFIG_FILENAME);
                 return setLogging(shell, true, true);
             case "disable":
                 return setLogging(shell, false, false);
@@ -463,4 +461,3 @@ public class ProtoLogImpl {
         }
     }
 }
-

diff --git a/services/java/com/android/server/SystemServer.java b/services/java/com/android/server/SystemServer.java
index 5c12f204..12a05679 100644
--- a/services/java/com/android/server/SystemServer.java
+++ b/services/java/com/android/server/SystemServer.java
@@ -1130,13 +1130,6 @@ public final class SystemServer {
             SQLiteCompatibilityWalFlags.reset();
             t.traceEnd();

-            // Records errors and logs, for example wtf()
-            // Currently this service indirectly depends on SettingsProvider so do this after
-            // InstallSystemProviders.
-            t.traceBegin("StartDropBoxManager");
-            mSystemServiceManager.startService(DropBoxManagerService.class);
-            t.traceEnd();
-
             t.traceBegin("StartVibratorService");
             vibrator = new VibratorService(context);
             ServiceManager.addService("vibrator", vibrator);
@@ -2169,7 +2162,6 @@ public final class SystemServer {
         // Emit any pending system_server WTFs
         synchronized (SystemService.class) {
             if (sPendingWtfs != null) {
-                mActivityManagerService.schedulePendingSystemServerWtfs(sPendingWtfs);
                 sPendingWtfs = null;
             }
         }

project frameworks/native/
diff --git a/cmds/atrace/Android.bp b/cmds/atrace/Android.bp
index e7d0ad0..9c0496a 100644
--- a/cmds/atrace/Android.bp
+++ b/cmds/atrace/Android.bp
@@ -1,30 +1 @@
 // Copyright 2012 The Android Open Source Project
-
-cc_binary {
-    name: "atrace",
-    srcs: ["atrace.cpp"],
-    cflags: [
-        "-Wall",
-        "-Werror",
-    ],
-
-    shared_libs: [
-        "libbinder",
-        "libhidlbase",
-        "liblog",
-        "libutils",
-        "libcutils",
-        "libz",
-        "libbase",
-        "libpdx_default_transport",
-        "android.hardware.atrace@1.0",
-    ],
-
-    init_rc: ["atrace.rc"],
-
-    product_variables: {
-        debuggable: {
-            init_rc: ["atrace_userdebug.rc"],
-        },
-    },
-}

project packages/apps/LineageParts/
diff --git a/res/values-zh-rCN/strings.xml b/res/values-zh-rCN/strings.xml
index 3e3ffee..c91c9f4 100644
--- a/res/values-zh-rCN/strings.xml
+++ b/res/values-zh-rCN/strings.xml
@@ -181,6 +181,8 @@
     <string name="home_answer_call_summary">按 Home 键接听来电</string>
     <string name="extras_title">附加功能</string>
     <string name="additional_buttons_title">附加按钮</string>
+    <string name="edge_gesture_title">边缘触控</string>
+    <string name="edge_gesture_summary">双击手机侧边可触发返回操作</string>
     <string name="click_partial_screenshot_title">点击以进行局部截图</string>
     <string name="click_partial_screenshot_summary">同时按音量下和电源键以截取局部截图</string>
     <string name="button_backlight_title">背光</string>
@@ -463,6 +465,8 @@
     <string name="auto_power_save_summary_on">电量 %s 时自动启用省电</string>
     <string name="auto_power_save_summary_off">不要自动启用省电</string>
     <string name="auto_power_save_never">永不</string>
+    <string name="cpu_overclock_title">高性能模式</string>
+    <string name="cpu_overclock_summary">提升处理器最大功率以改善性能，但可能缩短续航时间</string>
     <string name="long_screen_settings_title">全屏应用</string>
     <string name="long_screen_settings_summary">强制旧式应用程序使用全屏长宽比</string>
     <string name="long_screen_settings_no_apps">无应用</string>

diff --git a/res/values-zh-rTW/strings.xml b/res/values-zh-rTW/strings.xml
index c6f0f4f..684fefc 100644
--- a/res/values-zh-rTW/strings.xml
+++ b/res/values-zh-rTW/strings.xml
@@ -181,6 +181,8 @@
     <string name="home_answer_call_summary">按主畫面鍵接聽來電</string>
     <string name="extras_title">附加功能</string>
     <string name="additional_buttons_title">附加按鍵</string>
+    <string name="edge_gesture_title">邊緣觸控</string>
+    <string name="edge_gesture_summary">雙擊手機側面以返回</string>
     <string name="click_partial_screenshot_title">點擊以局部螢幕截圖</string>
     <string name="click_partial_screenshot_summary">短按音量下鍵與電源鍵以局部螢幕截圖</string>
     <string name="button_backlight_title">背光</string>
@@ -461,6 +463,8 @@
     <string name="auto_power_save_summary_on">在 %s 電量時自動啟用省電模式</string>
     <string name="auto_power_save_summary_off">不要自動啟用省電模式</string>
     <string name="auto_power_save_never">永不</string>
+    <string name="cpu_overclock_title">高效能模式</string>
+    <string name="cpu_overclock_summary">提高處理器功耗上限以增進性能，但可能縮短續航時間</string>
     <string name="long_screen_settings_title">全螢幕應用程式</string>
     <string name="long_screen_settings_summary">強制舊型應用程式使用全螢幕的比例</string>
     <string name="long_screen_settings_no_apps">沒有應用程式</string>

diff --git a/res/values/strings.xml b/res/values/strings.xml
index 8cdb211..a399aad 100644
--- a/res/values/strings.xml
+++ b/res/values/strings.xml
@@ -215,6 +215,8 @@
     <string name="home_answer_call_summary">Answer incoming calls by pressing the home button</string>
     <string name="extras_title">Extras</string>
     <string name="additional_buttons_title">Additional buttons</string>
+    <string name="edge_gesture_title">Edge gesture</string>
+    <string name="edge_gesture_summary">Double tap the phone\'s edge causes back</string>
     <string name="click_partial_screenshot_title">Click to partial screenshot</string>
     <string name="click_partial_screenshot_summary">Short click Volume Down and Power to take partial screenshot</string>

@@ -593,6 +595,8 @@
     <string name="auto_power_save_summary_on">Automatically enable power save mode at %s battery</string>
     <string name="auto_power_save_summary_off">Do not enable power save mode automatically</string>
     <string name="auto_power_save_never">Never</string>
+    <string name="cpu_overclock_title">High performance mode</string>
+    <string name="cpu_overclock_summary">Increase maximum CPU power to improve performance, at the cost of battery life</string>

     <!-- Applications: Long screen -->
     <string name="long_screen_settings_title">Full screen apps</string>

diff --git a/res/xml/button_settings.xml b/res/xml/button_settings.xml
index 5234a96..236947f 100644
--- a/res/xml/button_settings.xml
+++ b/res/xml/button_settings.xml
@@ -336,6 +336,12 @@
                 android:action="org.lineageos.settings.device.ADDITIONAL_BUTTONS_SETTINGS" />
         </lineageos.preference.RemotePreference>

+        <SwitchPreference
+            android:key="edge_gesture"
+            android:title="@string/edge_gesture_title"
+            android:summary="@string/edge_gesture_summary"
+            android:persistent="false" />
+
         <lineageos.preference.LineageSystemSettingSwitchPreference
             android:key="click_partial_screenshot"
             android:title="@string/click_partial_screenshot_title"

diff --git a/res/xml/perf_profile_settings.xml b/res/xml/perf_profile_settings.xml
index 0b301a9..7a129d5 100644
--- a/res/xml/perf_profile_settings.xml
+++ b/res/xml/perf_profile_settings.xml
@@ -37,6 +37,18 @@

     </PreferenceCategory>

+    <PreferenceCategory
+        android:key="cpu_overclock_category"
+        android:title="@string/advanced">
+
+        <SwitchPreference
+            android:key="cpu_overclock"
+            android:title="@string/cpu_overclock_title"
+            android:summary="@string/cpu_overclock_summary"
+            android:persistent="false" />
+
+    </PreferenceCategory>
+
     <PreferenceCategory
         android:key="perf_profile_category"
         android:title="@string/perf_profile_category_title">

diff --git a/src/org/lineageos/lineageparts/input/ButtonSettings.java b/src/org/lineageos/lineageparts/input/ButtonSettings.java
index 613e847..e58aff8 100644
--- a/src/org/lineageos/lineageparts/input/ButtonSettings.java
+++ b/src/org/lineageos/lineageparts/input/ButtonSettings.java
@@ -29,6 +29,7 @@ import android.content.SharedPreferences;
 import android.os.Bundle;
 import android.os.Handler;
 import android.os.RemoteException;
+import android.os.SystemProperties;
 import android.os.UserHandle;
 import android.provider.Settings;
 import android.util.ArraySet;
@@ -103,6 +104,7 @@ public class ButtonSettings extends SettingsPreferenceFragment
             "torch_long_press_power_gesture";
     private static final String KEY_TORCH_LONG_PRESS_POWER_TIMEOUT =
             "torch_long_press_power_timeout";
+    private static final String KEY_EDGE_GESTURE = "edge_gesture";
     private static final String KEY_CLICK_PARTIAL_SCREENSHOT =
             "click_partial_screenshot";
     private static final String KEY_SWAP_CAPACITIVE_KEYS = "swap_capacitive_keys";
@@ -147,6 +149,7 @@ public class ButtonSettings extends SettingsPreferenceFragment
     private SwitchPreference mHomeAnswerCall;
     private SwitchPreference mTorchLongPressPowerGesture;
     private ListPreference mTorchLongPressPowerTimeout;
+    private SwitchPreference mEdgeGesture;
     private SwitchPreference mSwapCapacitiveKeys;

     private PreferenceCategory mNavigationPreferencesCat;
@@ -470,6 +473,13 @@ public class ButtonSettings extends SettingsPreferenceFragment
             mSwapCapacitiveKeys.setDependency(KEY_DISABLE_NAV_KEYS);
         }

+        // Edge gesture controller
+        mEdgeGesture = prefScreen.findPreference(KEY_EDGE_GESTURE);
+
+        if (mEdgeGesture != null) {
+            mEdgeGesture.setChecked(SystemProperties.getBoolean("persist.vendor.edge_touch_mode", false));
+        }
+
         // Override key actions on Go devices in order to hide any unsupported features
         if (ActivityManager.isLowRamDeviceStatic()) {
             String[] actionEntriesGo = res.getStringArray(R.array.hardware_keys_action_entries_go);
@@ -552,6 +562,11 @@ public class ButtonSettings extends SettingsPreferenceFragment
                 (incallHomeBehavior == LineageSettings.Secure.RING_HOME_BUTTON_BEHAVIOR_ANSWER);
             mHomeAnswerCall.setChecked(homeButtonAnswersCall);
         }
+
+        // Get edge gesture status.
+        if (mEdgeGesture != null) {
+            mEdgeGesture.setChecked(SystemProperties.getBoolean("persist.vendor.edge_touch_mode", false));
+        }
     }

     private ListPreference initList(String key, Action value) {
@@ -837,6 +852,9 @@ public class ButtonSettings extends SettingsPreferenceFragment
         } else if (preference == mHomeAnswerCall) {
             handleToggleHomeButtonAnswersCallPreferenceClick();
             return true;
+        } else if (preference == mEdgeGesture) {
+            SystemProperties.set("persist.vendor.edge_touch_mode", mEdgeGesture.isChecked() ? "true" : "false");
+            return true;
         }

         return super.onPreferenceTreeClick(preference);

diff --git a/src/org/lineageos/lineageparts/power/PerfProfileSettings.java b/src/org/lineageos/lineageparts/power/PerfProfileSettings.java
index 949562f..82a103f 100644
--- a/src/org/lineageos/lineageparts/power/PerfProfileSettings.java
+++ b/src/org/lineageos/lineageparts/power/PerfProfileSettings.java
@@ -28,6 +28,7 @@ import android.graphics.drawable.AnimatedVectorDrawable;
 import android.net.Uri;
 import android.os.Bundle;
 import android.os.PowerManager;
+import android.os.SystemProperties;
 import android.provider.Settings.Global;
 import android.util.ArraySet;
 import android.util.TypedValue;
@@ -65,10 +66,13 @@ public class PerfProfileSettings extends SettingsPreferenceFragment
     private static final String KEY_AUTO_POWER_SAVE  = "auto_power_save";
     private static final String KEY_POWER_SAVE       = "power_save";
     private static final String KEY_PERF_SEEKBAR     = "perf_seekbar";
+    private static final String KEY_CPU_OVERCLOCK    = "cpu_overclock";

     private ListPreference mAutoPowerSavePref;
     private SwitchPreference   mPowerSavePref;

+    private SwitchPreference   mCPUOverclockPref;
+
     private SeekBarPreference        mPerfSeekBar;
     private StopMotionVectorDrawable mPerfDrawable;
     private PerfIconAnimator         mAnimator;
@@ -96,6 +100,7 @@ public class PerfProfileSettings extends SettingsPreferenceFragment
         mPerfSeekBar = findPreference(KEY_PERF_SEEKBAR);
         mAutoPowerSavePref = findPreference(KEY_AUTO_POWER_SAVE);
         mPowerSavePref = findPreference(KEY_POWER_SAVE);
+        mCPUOverclockPref = findPreference(KEY_CPU_OVERCLOCK);

         mPowerManager = getActivity().getSystemService(PowerManager.class);
         mPerf = PerformanceManager.getInstance(getActivity());
@@ -126,6 +131,8 @@ public class PerfProfileSettings extends SettingsPreferenceFragment
         updateAutoPowerSaveValue();
         mAutoPowerSavePref.setOnPreferenceChangeListener(this);
         mPowerSavePref.setOnPreferenceChangeListener(this);
+        updateCPUOverclockValue();
+        mCPUOverclockPref.setOnPreferenceChangeListener(this);
     }


@@ -212,6 +219,10 @@ public class PerfProfileSettings extends SettingsPreferenceFragment
             getActivity().registerReceiver(mPowerSaveReceiver,
                     new IntentFilter(PowerManager.ACTION_POWER_SAVE_MODE_CHANGING));
         }
+
+        if (mCPUOverclockPref != null) {
+            updateCPUOverclockValue();
+        }
     }

     @Override
@@ -246,6 +257,8 @@ public class PerfProfileSettings extends SettingsPreferenceFragment
             final int level = Integer.parseInt((String) newValue);
             Global.putInt(getContentResolver(), Global.LOW_POWER_MODE_TRIGGER_LEVEL, level);
             updateAutoPowerSaveSummary(level);
+        } else if (preference == mCPUOverclockPref) {
+            SystemProperties.set("persist.sys.cpu_overclock", mCPUOverclockPref.isChecked() ? "false" : "true");
         }
         return true;
     }
@@ -263,6 +276,10 @@ public class PerfProfileSettings extends SettingsPreferenceFragment
         PartsUpdater.notifyChanged(getActivity(), getPreferenceScreen().getKey());
     }

+    private void updateCPUOverclockValue() {
+        mCPUOverclockPref.setChecked(SystemProperties.getBoolean("persist.sys.cpu_overclock", false));
+    }
+
     private void updateAutoPowerSaveValue() {
         final int level = Global.getInt(
                 getContentResolver(), Global.LOW_POWER_MODE_TRIGGER_LEVEL, 0);

project packages/apps/PermissionController/
diff --git a/src/com/android/permissioncontroller/permission/utils/Utils.java b/src/com/android/permissioncontroller/permission/utils/Utils.java
index 65fdd59..fdd71e2 100644
--- a/src/com/android/permissioncontroller/permission/utils/Utils.java
+++ b/src/com/android/permissioncontroller/permission/utils/Utils.java
@@ -23,6 +23,7 @@ import static android.Manifest.permission_group.CALENDAR;
 import static android.Manifest.permission_group.CALL_LOG;
 import static android.Manifest.permission_group.CAMERA;
 import static android.Manifest.permission_group.CONTACTS;
+import static android.Manifest.permission_group.FAKE_PACKAGE;
 import static android.Manifest.permission_group.LOCATION;
 import static android.Manifest.permission_group.MICROPHONE;
 import static android.Manifest.permission_group.PHONE;
@@ -209,6 +210,8 @@ public final class Utils {

         PLATFORM_PERMISSIONS.put(Manifest.permission.BODY_SENSORS, SENSORS);

+        PLATFORM_PERMISSIONS.put(Manifest.permission.FAKE_PACKAGE_SIGNATURE, FAKE_PACKAGE);
+
         PLATFORM_PERMISSION_GROUPS = new ArrayMap<>();
         int numPlatformPermissions = PLATFORM_PERMISSIONS.size();
         for (int i = 0; i < numPlatformPermissions; i++) {

project packages/apps/Settings/
diff --git a/src/com/android/settings/development/AdbRootPreferenceController.java b/src/com/android/settings/development/AdbRootPreferenceController.java
index 5f7d65d..8cdc24f 100644
--- a/src/com/android/settings/development/AdbRootPreferenceController.java
+++ b/src/com/android/settings/development/AdbRootPreferenceController.java
@@ -53,7 +53,7 @@ public class AdbRootPreferenceController extends DeveloperOptionsPreferenceContr

     @Override
     public boolean isAvailable() {
-        return Build.IS_DEBUGGABLE;
+        return true;
     }

     @Override

project system/core/
diff --git a/adb/daemon/main.cpp b/adb/daemon/main.cpp
index 1e33128..8cb9f46 100644
--- a/adb/daemon/main.cpp
+++ b/adb/daemon/main.cpp
@@ -74,7 +74,6 @@ static bool should_drop_privileges() {
     // ro.secure:
     //   Drop privileges by default. Set to 1 on userdebug and user builds.
     bool ro_secure = android::base::GetBoolProperty("ro.secure", true);
-    bool ro_debuggable = __android_log_is_debuggable();

     // Drop privileges if ro.secure is set...
     bool drop = ro_secure;
@@ -83,7 +82,7 @@ static bool should_drop_privileges() {
     std::string prop = android::base::GetProperty("service.adb.root", "");
     bool adb_root = (prop == "1");
     bool adb_unroot = (prop == "0");
-    if (ro_debuggable && adb_root) {
+    if (adb_root) {
         drop = false;
     }
     // ... and "adb unroot" lets you explicitly drop privileges.

diff --git a/adb/root/adbroot_service.cpp b/adb/root/adbroot_service.cpp
index 0cd9825..90a6c0a 100644
--- a/adb/root/adbroot_service.cpp
+++ b/adb/root/adbroot_service.cpp
@@ -72,8 +72,11 @@ ndk::ScopedAStatus ADBRootService::setEnabled(bool enabled) {
         enabled_ = enabled;
         WriteStringToFile(std::to_string(enabled), kStoragePath + kEnabled);

-        // Turning off adb root, restart adbd.
-        if (!enabled) {
+        // Turning on/off adb root, restart adbd.
+        if (enabled) {
+            SetProperty("service.adb.root", "1");
+            SetProperty("ctl.restart", "adbd");
+        } else {
             SetProperty("service.adb.root", "0");
             SetProperty("ctl.restart", "adbd");
         }

diff --git a/init/Android.bp b/init/Android.bp
index f292d68..b685e24 100644
--- a/init/Android.bp
+++ b/init/Android.bp
@@ -94,7 +94,7 @@ cc_defaults {
         "-Wthread-safety",
         "-DALLOW_FIRST_STAGE_CONSOLE=0",
         "-DALLOW_LOCAL_PROP_OVERRIDE=0",
-        "-DALLOW_PERMISSIVE_SELINUX=0",
+        "-DALLOW_PERMISSIVE_SELINUX=1",
         "-DREBOOT_BOOTLOADER_ON_PANIC=0",
         "-DWORLD_WRITABLE_KMSG=0",
         "-DDUMP_ON_UMOUNT_FAILURE=0",

diff --git a/init/Android.mk b/init/Android.mk
index 416b732..56a2478 100644
--- a/init/Android.mk
+++ b/init/Android.mk
@@ -18,7 +18,7 @@ else
 init_options += \
     -DALLOW_FIRST_STAGE_CONSOLE=0 \
     -DALLOW_LOCAL_PROP_OVERRIDE=0 \
-    -DALLOW_PERMISSIVE_SELINUX=0 \
+    -DALLOW_PERMISSIVE_SELINUX=1 \
     -DREBOOT_BOOTLOADER_ON_PANIC=0 \
     -DWORLD_WRITABLE_KMSG=0 \
     -DDUMP_ON_UMOUNT_FAILURE=0

diff --git a/libcutils/trace-dev.cpp b/libcutils/trace-dev.cpp
index 5a09a2d..080e671 100644
--- a/libcutils/trace-dev.cpp
+++ b/libcutils/trace-dev.cpp
@@ -24,23 +24,14 @@ static pthread_once_t atrace_once_control = PTHREAD_ONCE_INIT;
 // the Zygote process from tracing.
 void atrace_set_tracing_enabled(bool enabled)
 {
+    enabled = false;
     atomic_store_explicit(&atrace_is_enabled, enabled, memory_order_release);
     atrace_update_tags();
 }

 static void atrace_init_once()
 {
-    atrace_marker_fd = open("/sys/kernel/debug/tracing/trace_marker", O_WRONLY | O_CLOEXEC);
-    if (atrace_marker_fd == -1) {
-        atrace_marker_fd = open("/sys/kernel/tracing/trace_marker", O_WRONLY | O_CLOEXEC);
-    }
-
-    if (atrace_marker_fd == -1) {
-        ALOGE("Error opening trace file: %s (%d)", strerror(errno), errno);
-        atrace_enabled_tags = 0;
-    } else {
-      atrace_enabled_tags = atrace_get_property();
-    }
+    atrace_enabled_tags = 0;
 }

 static void atrace_seq_number_changed(uint32_t prev_seq_no, uint32_t seq_no) {

diff --git a/libcutils/trace-dev.inc b/libcutils/trace-dev.inc
index 6543426..a8fc338 100644
--- a/libcutils/trace-dev.inc
+++ b/libcutils/trace-dev.inc
@@ -52,7 +52,7 @@ atomic_bool              atrace_is_ready      = ATOMIC_VAR_INIT(false);
 int                      atrace_marker_fd     = -1;
 uint64_t                 atrace_enabled_tags  = ATRACE_TAG_NOT_READY;
 static bool              atrace_is_debuggable = false;
-static atomic_bool       atrace_is_enabled    = ATOMIC_VAR_INIT(true);
+static atomic_bool       atrace_is_enabled    = ATOMIC_VAR_INIT(false);
 static pthread_mutex_t   atrace_tags_mutex    = PTHREAD_MUTEX_INITIALIZER;

 /**
@@ -100,6 +100,7 @@ uint64_t atrace_get_enabled_tags()
 // is not set to '1'.
 void atrace_set_debuggable(bool debuggable)
 {
+    debuggable = false;
     atrace_is_debuggable = debuggable;
     atrace_update_tags();
 }

diff --git a/rootdir/init.rc b/rootdir/init.rc
index a9af0b0..8f87abb 100644
--- a/rootdir/init.rc
+++ b/rootdir/init.rc
@@ -540,11 +540,6 @@ on post-fs-data
     # Make sure we have the device encryption key.
     installkey /data

-    # Start bootcharting as soon as possible after the data partition is
-    # mounted to collect more data.
-    mkdir /data/bootchart 0755 shell shell encryption=Require
-    bootchart start
-
     # Make sure that apexd is started in the default namespace
     enter_default_mount_ns

@@ -611,27 +606,13 @@ on post-fs-data
     mkdir /data/misc/audioserver 0700 audioserver audioserver
     mkdir /data/misc/cameraserver 0700 cameraserver cameraserver
     mkdir /data/misc/vold 0700 root root
-    mkdir /data/misc/boottrace 0771 system shell
-    mkdir /data/misc/update_engine 0700 root root
-    mkdir /data/misc/update_engine_log 02750 root log
-    mkdir /data/misc/trace 0700 root root
-    # create location to store surface and window trace files
-    mkdir /data/misc/wmtrace 0700 system system
     # profile file layout
     mkdir /data/misc/profiles 0771 system system
     mkdir /data/misc/profiles/cur 0771 system system
     mkdir /data/misc/profiles/ref 0770 system system
-    mkdir /data/misc/profman 0770 system shell
-    mkdir /data/misc/gcov 0770 root root
     mkdir /data/misc/installd 0700 root root
     mkdir /data/misc/apexdata 0711 root root
     mkdir /data/misc/apexrollback 0700 root root
-    mkdir /data/misc/snapshotctl_log 0755 root root
-    # create location to store pre-reboot information
-    mkdir /data/misc/prereboot 0700 system system
-
-    mkdir /data/preloads 0775 system system encryption=None
-
     mkdir /data/vendor 0771 root root encryption=Require
     mkdir /data/vendor_ce 0771 root root encryption=None
     mkdir /data/vendor_de 0771 root root encryption=None
@@ -640,7 +621,6 @@ on post-fs-data
     # For security reasons, /data/local/tmp should always be empty.
     # Do not place files or directories in /data/local/tmp
     mkdir /data/local/tmp 0771 shell shell
-    mkdir /data/local/traces 0777 shell shell
     mkdir /data/data 0771 system system encryption=None
     mkdir /data/app-private 0771 system system encryption=Require
     mkdir /data/app-ephemeral 0771 system system encryption=Require
@@ -648,18 +628,9 @@ on post-fs-data
     mkdir /data/app-lib 0771 system system encryption=Require
     mkdir /data/app 0771 system system encryption=Require
     mkdir /data/property 0700 root root encryption=Require
-    mkdir /data/tombstones 0771 system system encryption=Require
-    mkdir /data/vendor/tombstones 0771 root root
-    mkdir /data/vendor/tombstones/wifi 0771 wifi wifi

     # create dalvik-cache, so as to enforce our permissions
     mkdir /data/dalvik-cache 0771 root root encryption=Require
-    # create the A/B OTA directory, so as to enforce our permissions
-    mkdir /data/ota 0771 root root encryption=Require
-
-    # create the OTA package directory. It will be accessed by GmsCore (cache
-    # group), update_engine and update_verifier.
-    mkdir /data/ota_package 0770 system cache encryption=Require

     # create resource-cache and double-check the perms
     mkdir /data/resource-cache 0771 system system encryption=Require
@@ -677,20 +648,11 @@ on post-fs-data
     # the following directory.
     mkdir /data/mediadrm 0770 mediadrm mediadrm encryption=Require

-    mkdir /data/anr 0775 system system encryption=Require
-
-    # NFC: create data/nfc for nv storage
-    mkdir /data/nfc 0770 nfc nfc encryption=Require
-    mkdir /data/nfc/param 0770 nfc nfc
-
     # Create all remaining /data root dirs so that they are made through init
     # and get proper encryption policy installed
     mkdir /data/backup 0700 system system encryption=Require
-    mkdir /data/ss 0700 system system encryption=Require

     mkdir /data/system 0775 system system encryption=Require
-    mkdir /data/system/dropbox 0700 system system
-    mkdir /data/system/heapdump 0700 system system
     mkdir /data/system/users 0775 system system

     mkdir /data/system_de 0770 system system encryption=None
@@ -728,17 +690,7 @@ on post-fs-data
     mkdir /data_mirror/cur_profiles 0700 root root
     mount none /data/misc/profiles/cur /data_mirror/cur_profiles bind rec

-    mkdir /data/cache 0770 system cache encryption=Require
-    mkdir /data/cache/recovery 0770 system cache
-    mkdir /data/cache/backup_stage 0700 system system
-    mkdir /data/cache/backup 0700 system system
-
-    # Delete these if need be, per b/139193659
-    mkdir /data/rollback 0700 system system encryption=DeleteIfNecessary
-    mkdir /data/rollback-observer 0700 system system encryption=DeleteIfNecessary
-
-    # Create root dir for Incremental Service
-    mkdir /data/incremental 0771 system system encryption=Require
+    symlink /cache /data/cache

     # Create directories for statsd
     mkdir /data/misc/stats-active-metric/ 0770 statsd system
@@ -978,12 +930,6 @@ on property:vold.decrypt=trigger_shutdown_framework
     class_reset_post_data core
     class_reset_post_data hal

-on property:sys.boot_completed=1
-    bootchart stop
-    # Setup per_boot directory so other .rc could start to use it on boot_completed
-    exec - system system -- /bin/rm -rf /data/per_boot
-    mkdir /data/per_boot 0700 system system encryption=Require key=per_boot_ref
-
 # system server cannot write to /proc/sys files,
 # and chown/chmod does not work for /proc/sys/ entries.
 # So proxy writes through init.
@@ -1043,13 +989,6 @@ service console /system/bin/sh
     seclabel u:r:shell:s0
     setenv HOSTNAME console

-on property:ro.debuggable=1
-    # Give writes to anyone for the trace folder on debug builds.
-    # The folder is used to store method traces.
-    chmod 0773 /data/misc/trace
-    # Give reads to anyone for the window trace folder on debug builds.
-    chmod 0775 /data/misc/wmtrace
-
 on init && property:ro.debuggable=1
     start console

project system/sepolicy/
diff --git a/Android.mk b/Android.mk
index 2245dff..a5bd6ac 100644
--- a/Android.mk
+++ b/Android.mk
@@ -85,10 +85,12 @@ ifndef BOARD_SEPOLICY_VERS
 BOARD_SEPOLICY_VERS := $(PLATFORM_SEPOLICY_VERSION)
 endif

-NEVERALLOW_ARG :=
+# Hacks to keep SELinux permissive in user builds
+SELINUX_IGNORE_NEVERALLOWS := true
+
 ifeq ($(SELINUX_IGNORE_NEVERALLOWS),true)
 ifeq ($(TARGET_BUILD_VARIANT),user)
-$(error SELINUX_IGNORE_NEVERALLOWS := true cannot be used in user builds)
+$(warning SELINUX_IGNORE_NEVERALLOWS := true cannot be used in user builds)
 endif
 $(warning Be careful when using the SELINUX_IGNORE_NEVERALLOWS flag. \
           It does not work in user builds and using it will \
@@ -1301,10 +1303,9 @@ $(built_sepolicy_neverallows)
 	$(hide) $(HOST_OUT_EXECUTABLES)/sepolicy-analyze $@.tmp permissive > $@.permissivedomains
 	$(hide) if [ "$(TARGET_BUILD_VARIANT)" = "user" -a -s $@.permissivedomains ]; then \
 		echo "==========" 1>&2; \
-		echo "ERROR: permissive domains not allowed in user builds" 1>&2; \
+		echo "WARNING: permissive domains not allowed in user builds" 1>&2; \
 		echo "List of invalid domains:" 1>&2; \
 		cat $@.permissivedomains 1>&2; \
-		exit 1; \
 		fi
 	$(hide) mv $@.tmp $@

@@ -1358,10 +1359,9 @@ $(LOCAL_BUILT_MODULE): $(sepolicy.recovery.conf) $(HOST_OUT_EXECUTABLES)/checkpo
 	$(hide) $(HOST_OUT_EXECUTABLES)/sepolicy-analyze $@.tmp permissive > $@.permissivedomains
 	$(hide) if [ "$(TARGET_BUILD_VARIANT)" = "user" -a -s $@.permissivedomains ]; then \
 		echo "==========" 1>&2; \
-		echo "ERROR: permissive domains not allowed in user builds" 1>&2; \
+		echo "WARNING: permissive domains not allowed in user builds" 1>&2; \
 		echo "List of invalid domains:" 1>&2; \
 		cat $@.permissivedomains 1>&2; \
-		exit 1; \
 		fi
 	$(hide) mv $@.tmp $@

project vendor/lineage/
diff --git a/config/BoardConfigKernel.mk b/config/BoardConfigKernel.mk
index e26127a..8f71933 100644
--- a/config/BoardConfigKernel.mk
+++ b/config/BoardConfigKernel.mk
@@ -52,11 +52,11 @@ endif
 CLANG_PREBUILTS := $(BUILD_TOP)/prebuilts/clang/host/$(HOST_PREBUILT_TAG)/clang-r383902b
 GCC_PREBUILTS := $(BUILD_TOP)/prebuilts/gcc/$(HOST_PREBUILT_TAG)
 # arm64 toolchain
-KERNEL_TOOLCHAIN_arm64 := $(GCC_PREBUILTS)/aarch64/aarch64-linux-android-4.9/bin
-KERNEL_TOOLCHAIN_PREFIX_arm64 := aarch64-linux-android-
+KERNEL_TOOLCHAIN_arm64 := /usr/bin
+KERNEL_TOOLCHAIN_PREFIX_arm64 := aarch64-linux-gnu-
 # arm toolchain
-KERNEL_TOOLCHAIN_arm := $(GCC_PREBUILTS)/arm/arm-linux-androideabi-4.9/bin
-KERNEL_TOOLCHAIN_PREFIX_arm := arm-linux-androidkernel-
+KERNEL_TOOLCHAIN_arm := /usr/bin
+KERNEL_TOOLCHAIN_PREFIX_arm := arm-linux-gnueabihf-
 # x86 toolchain
 KERNEL_TOOLCHAIN_x86 := $(GCC_PREBUILTS)/x86/x86_64-linux-android-4.9/bin
 KERNEL_TOOLCHAIN_PREFIX_x86 := x86_64-linux-android-

diff --git a/config/common.mk b/config/common.mk
index d5faf3f..a2c2718 100644
--- a/config/common.mk
+++ b/config/common.mk
@@ -103,42 +103,21 @@ PRODUCT_RESTRICT_VENDOR_FILES := false
 # Bootanimation
 TARGET_SCREEN_WIDTH ?= 1080
 TARGET_SCREEN_HEIGHT ?= 1920
-PRODUCT_PACKAGES += \
-    bootanimation.zip

 # Lineage packages
 PRODUCT_PACKAGES += \
     LineageParts \
     LineageSettingsProvider \
-    LineageSetupWizard \
-    Updater
+    LineageSetupWizard

 # Themes
 PRODUCT_PACKAGES += \
-    LineageThemesStub \
     ThemePicker

 # Config
 PRODUCT_PACKAGES += \
     SimpleDeviceConfig

-# Extra tools in Lineage
-PRODUCT_PACKAGES += \
-    7z \
-    bash \
-    curl \
-    getcap \
-    htop \
-    lib7z \
-    libsepol \
-    nano \
-    pigz \
-    setcap \
-    unrar \
-    vim \
-    wget \
-    zip
-
 # Filesystems tools
 PRODUCT_PACKAGES += \
     fsck.ntfs \
@@ -146,20 +125,6 @@ PRODUCT_PACKAGES += \
     mkfs.ntfs \
     mount.ntfs

-# Openssh
-PRODUCT_PACKAGES += \
-    scp \
-    sftp \
-    ssh \
-    sshd \
-    sshd_config \
-    ssh-keygen \
-    start-ssh
-
-# rsync
-PRODUCT_PACKAGES += \
-    rsync
-
 # Storage manager
 PRODUCT_SYSTEM_DEFAULT_PROPERTIES += \
     ro.storage_manager.enabled=true

diff --git a/config/common_full.mk b/config/common_full.mk
index 91bf198..67bfa73 100644
--- a/config/common_full.mk
+++ b/config/common_full.mk
@@ -3,16 +3,6 @@ $(call inherit-product, vendor/lineage/config/common_mobile.mk)

 PRODUCT_SIZE := full

-# Include {Lato,Rubik} fonts
-$(call inherit-product-if-exists, external/google-fonts/lato/fonts.mk)
-$(call inherit-product-if-exists, external/google-fonts/rubik/fonts.mk)
-
-# Fonts
-PRODUCT_PACKAGES += \
-    fonts_customization.xml \
-    LineageLatoFont \
-    LineageRubikFont
-
 # Recorder
 PRODUCT_PACKAGES += \
     Recorder

diff --git a/config/common_mobile.mk b/config/common_mobile.mk
index 1f1c241..1f0f443 100644
--- a/config/common_mobile.mk
+++ b/config/common_mobile.mk
@@ -8,23 +8,14 @@ PRODUCT_PRODUCT_PROPERTIES += \

 # AOSP packages
 PRODUCT_PACKAGES += \
-    Email \
-    ExactCalculator \
-    Exchange2
+    ExactCalculator

 # Lineage packages
 PRODUCT_PACKAGES += \
     Backgrounds \
     Eleven \
     Etar \
-    Jelly \
-    Profiles \
-    Seedvault
-
-ifneq ($(TARGET_EXCLUDES_AUDIOFX),true)
-PRODUCT_PACKAGES += \
-    AudioFX
-endif
+    Jelly

 ifeq ($(PRODUCT_TYPE), go)
 PRODUCT_PACKAGES += \
@@ -40,20 +31,6 @@ PRODUCT_DEXPREOPT_SPEED_APPS += \
     TrebuchetQuickStep
 endif

-# Accents
-PRODUCT_PACKAGES += \
-    LineageBlackTheme \
-    LineageBlackAccent \
-    LineageBlueAccent \
-    LineageBrownAccent \
-    LineageCyanAccent \
-    LineageGreenAccent \
-    LineageOrangeAccent \
-    LineagePinkAccent \
-    LineagePurpleAccent \
-    LineageRedAccent \
-    LineageYellowAccent
-
 # Charger
 PRODUCT_PACKAGES += \
     charger_res_images
@@ -65,7 +42,6 @@ endif

 # Customizations
 PRODUCT_PACKAGES += \
-    IconShapeSquareOverlay \
     LineageNavigationBarNoHint \
     NavigationBarMode2ButtonOverlay

diff --git a/config/data_only.mk b/config/data_only.mk
index 5ff877c..ab70301 100644
--- a/config/data_only.mk
+++ b/config/data_only.mk
@@ -1,7 +1,3 @@
 # World APN list
 PRODUCT_PACKAGES += \
     apns-conf.xml
-
-# Telephony packages
-PRODUCT_PACKAGES += \
-    Stk

diff --git a/config/telephony.mk b/config/telephony.mk
index 6adf48d..e63b320 100644
--- a/config/telephony.mk
+++ b/config/telephony.mk
@@ -8,8 +8,7 @@ PRODUCT_PACKAGES += \

 # Telephony packages
 PRODUCT_PACKAGES += \
-    messaging \
-    Stk
+    messaging

 # Default ringtone
 PRODUCT_PRODUCT_PROPERTIES += \

diff --git a/overlay/common/frameworks/base/core/res/res/values/colors.xml b/overlay/common/frameworks/base/core/res/res/values/colors.xml
deleted file mode 100644
index 27fd690..0000000
--- a/overlay/common/frameworks/base/core/res/res/values/colors.xml
+++ /dev/null

diff --git a/prebuilt/common/etc/fonts_customization.xml b/prebuilt/common/etc/fonts_customization.xml
deleted file mode 100644
index 0c9a7fb..0000000
--- a/prebuilt/common/etc/fonts_customization.xml
+++ /dev/null

diff --git a/prebuilt/common/etc/init/lineage-ssh.rc b/prebuilt/common/etc/init/lineage-ssh.rc
deleted file mode 100644
index f3613c3..0000000
--- a/prebuilt/common/etc/init/lineage-ssh.rc
+++ /dev/null

diff --git a/prebuilt/common/etc/init/lineage-system.rc b/prebuilt/common/etc/init/lineage-system.rc
index f26a64b..deb4c99 100644
--- a/prebuilt/common/etc/init/lineage-system.rc
+++ b/prebuilt/common/etc/init/lineage-system.rc
@@ -8,9 +8,3 @@ on post-fs-data
     # Change permissions on fsck log so it can be added to the dropbox
     chown root log /dev/fscklogs/log
     chmod 0640 /dev/fscklogs/log
-
-# bugreport is triggered by holding down volume down, volume up and power
-service bugreport /system/bin/dumpstate -d -p -z
-    oneshot
-    disabled
-    keycodes 114 115 116

diff --git a/prebuilt/common/etc/init/lineage-updates.rc b/prebuilt/common/etc/init/lineage-updates.rc
deleted file mode 100644
index f1bed8d..0000000
--- a/prebuilt/common/etc/init/lineage-updates.rc
+++ /dev/null
